<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WGR-V Verilog Doku</title>

    <style>
    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        background-color: #0d1117;
        color: #c9d1d9;
        display: flex;
    }
    .header {
        display: none;
    }
    .sidebar {
        background-color: #161b22;
        width: 250px;
        padding: 20px;
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        overflow-y: auto;
        transition: transform 0.3s ease;
    }
    .content {
        margin-left: 300px;
        padding: 20px;
        flex: 1;
    }
    a {
        color: #58a6ff;
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    .codehilite pre {
        border-radius: 4px;
        padding: 0.3em 0.6em;
        overflow-x: auto;
    }
    code {
        background-color: #272822;
        border-radius: 3px;
        padding: 0.2em 0.4em;
        display: inline-block;
    }
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.codehilite .hll { background-color: #49483e }
.codehilite { background: #272822; color: #f8f8f2 }
.codehilite .c { color: #959077 } /* Comment */
.codehilite .err { color: #ed007e; background-color: #1e0010 } /* Error */
.codehilite .esc { color: #f8f8f2 } /* Escape */
.codehilite .g { color: #f8f8f2 } /* Generic */
.codehilite .k { color: #66d9ef } /* Keyword */
.codehilite .l { color: #ae81ff } /* Literal */
.codehilite .n { color: #f8f8f2 } /* Name */
.codehilite .o { color: #ff4689 } /* Operator */
.codehilite .x { color: #f8f8f2 } /* Other */
.codehilite .p { color: #f8f8f2 } /* Punctuation */
.codehilite .ch { color: #959077 } /* Comment.Hashbang */
.codehilite .cm { color: #959077 } /* Comment.Multiline */
.codehilite .cp { color: #959077 } /* Comment.Preproc */
.codehilite .cpf { color: #959077 } /* Comment.PreprocFile */
.codehilite .c1 { color: #959077 } /* Comment.Single */
.codehilite .cs { color: #959077 } /* Comment.Special */
.codehilite .gd { color: #ff4689 } /* Generic.Deleted */
.codehilite .ge { color: #f8f8f2; font-style: italic } /* Generic.Emph */
.codehilite .ges { color: #f8f8f2; font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.codehilite .gr { color: #f8f8f2 } /* Generic.Error */
.codehilite .gh { color: #f8f8f2 } /* Generic.Heading */
.codehilite .gi { color: #a6e22e } /* Generic.Inserted */
.codehilite .go { color: #66d9ef } /* Generic.Output */
.codehilite .gp { color: #ff4689; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { color: #f8f8f2; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #959077 } /* Generic.Subheading */
.codehilite .gt { color: #f8f8f2 } /* Generic.Traceback */
.codehilite .kc { color: #66d9ef } /* Keyword.Constant */
.codehilite .kd { color: #66d9ef } /* Keyword.Declaration */
.codehilite .kn { color: #ff4689 } /* Keyword.Namespace */
.codehilite .kp { color: #66d9ef } /* Keyword.Pseudo */
.codehilite .kr { color: #66d9ef } /* Keyword.Reserved */
.codehilite .kt { color: #66d9ef } /* Keyword.Type */
.codehilite .ld { color: #e6db74 } /* Literal.Date */
.codehilite .m { color: #ae81ff } /* Literal.Number */
.codehilite .s { color: #e6db74 } /* Literal.String */
.codehilite .na { color: #a6e22e } /* Name.Attribute */
.codehilite .nb { color: #f8f8f2 } /* Name.Builtin */
.codehilite .nc { color: #a6e22e } /* Name.Class */
.codehilite .no { color: #66d9ef } /* Name.Constant */
.codehilite .nd { color: #a6e22e } /* Name.Decorator */
.codehilite .ni { color: #f8f8f2 } /* Name.Entity */
.codehilite .ne { color: #a6e22e } /* Name.Exception */
.codehilite .nf { color: #a6e22e } /* Name.Function */
.codehilite .nl { color: #f8f8f2 } /* Name.Label */
.codehilite .nn { color: #f8f8f2 } /* Name.Namespace */
.codehilite .nx { color: #a6e22e } /* Name.Other */
.codehilite .py { color: #f8f8f2 } /* Name.Property */
.codehilite .nt { color: #ff4689 } /* Name.Tag */
.codehilite .nv { color: #f8f8f2 } /* Name.Variable */
.codehilite .ow { color: #ff4689 } /* Operator.Word */
.codehilite .pm { color: #f8f8f2 } /* Punctuation.Marker */
.codehilite .w { color: #f8f8f2 } /* Text.Whitespace */
.codehilite .mb { color: #ae81ff } /* Literal.Number.Bin */
.codehilite .mf { color: #ae81ff } /* Literal.Number.Float */
.codehilite .mh { color: #ae81ff } /* Literal.Number.Hex */
.codehilite .mi { color: #ae81ff } /* Literal.Number.Integer */
.codehilite .mo { color: #ae81ff } /* Literal.Number.Oct */
.codehilite .sa { color: #e6db74 } /* Literal.String.Affix */
.codehilite .sb { color: #e6db74 } /* Literal.String.Backtick */
.codehilite .sc { color: #e6db74 } /* Literal.String.Char */
.codehilite .dl { color: #e6db74 } /* Literal.String.Delimiter */
.codehilite .sd { color: #e6db74 } /* Literal.String.Doc */
.codehilite .s2 { color: #e6db74 } /* Literal.String.Double */
.codehilite .se { color: #ae81ff } /* Literal.String.Escape */
.codehilite .sh { color: #e6db74 } /* Literal.String.Heredoc */
.codehilite .si { color: #e6db74 } /* Literal.String.Interpol */
.codehilite .sx { color: #e6db74 } /* Literal.String.Other */
.codehilite .sr { color: #e6db74 } /* Literal.String.Regex */
.codehilite .s1 { color: #e6db74 } /* Literal.String.Single */
.codehilite .ss { color: #e6db74 } /* Literal.String.Symbol */
.codehilite .bp { color: #f8f8f2 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #a6e22e } /* Name.Function.Magic */
.codehilite .vc { color: #f8f8f2 } /* Name.Variable.Class */
.codehilite .vg { color: #f8f8f2 } /* Name.Variable.Global */
.codehilite .vi { color: #f8f8f2 } /* Name.Variable.Instance */
.codehilite .vm { color: #f8f8f2 } /* Name.Variable.Magic */
.codehilite .il { color: #ae81ff } /* Literal.Number.Integer.Long */
    @media (max-width: 768px) {
        .header {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: #161b22;
            color: #c9d1d9;
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
        }
        .burger {
            cursor: pointer;
            font-size: 24px;
        }
        .sidebar {
            width: 250px;
            height: calc(100% - 50px);
            position: fixed;
            top: 50px;
            left: 0;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 999;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .content {
            margin-left: 0;
            padding: 70px 20px 20px 20px;
        }
    }
    </style>
    
</head>
<body>
<div class="header">
    <span class="burger" onclick="toggleSidebar()">&#9776;</span>
    <div class="title" style="flex: 1; text-align: center; font-size: 18px;">WGR-V Verilog Doku</div>
</div>
<div class="sidebar" id="sidebar">
<h1>WGR-V Verilog Doku</h1>
<h2>Inhaltsverzeichnis</h2>
<ul>
<li><strong>Datei:</strong> rtl/alu.v</li>
<li><a href="#module-alu">Modul: alu</a></li>
<li><strong>Datei:</strong> rtl/cpu.v</li>
<li><a href="#module-cpu">Modul: cpu</a></li>
<li><strong>Datei:</strong> rtl/defines.v</li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-defines">Modul: defines</a></li>
<li><a href="#module-unknown">Modul: Unknown</a></li>
<li><strong>Datei:</strong> rtl/fram/fram_ram.v</li>
<li><a href="#module-fram_ram">Modul: fram_ram</a></li>
<li><strong>Datei:</strong> rtl/fram/fram_spi.v</li>
<li><a href="#module-fram_spi">Modul: fram_spi</a></li>
<li><strong>Datei:</strong> rtl/fram/mb85rs64v.v</li>
<li><a href="#module-mb85rs64v">Modul: mb85rs64v</a></li>
<li><strong>Datei:</strong> rtl/memory.v</li>
<li><a href="#module-memory">Modul: memory</a></li>
<li><strong>Datei:</strong> rtl/peripherals/debug_module.v</li>
<li><a href="#module-debug_module">Modul: debug_module</a></li>
<li><strong>Datei:</strong> rtl/peripherals/fifo.v</li>
<li><a href="#module-fifo">Modul: fifo</a></li>
<li><strong>Datei:</strong> rtl/peripherals/gpio.v</li>
<li><a href="#module-gpio">Modul: gpio</a></li>
<li><strong>Datei:</strong> rtl/peripherals/peripheral_bus.v</li>
<li><a href="#module-peripheral_bus">Modul: peripheral_bus</a></li>
<li><strong>Datei:</strong> rtl/peripherals/pwm_timer.v</li>
<li><a href="#module-pwm_timer">Modul: pwm_timer</a></li>
<li><strong>Datei:</strong> rtl/peripherals/seq_divider.v</li>
<li><a href="#module-seq_divider">Modul: seq_divider</a></li>
<li><strong>Datei:</strong> rtl/peripherals/seq_multiplier.v</li>
<li><a href="#module-seq_multiplier">Modul: seq_multiplier</a></li>
<li><strong>Datei:</strong> rtl/peripherals/spi.v</li>
<li><a href="#module-spi">Modul: spi</a></li>
<li><strong>Datei:</strong> rtl/peripherals/system_timer.v</li>
<li><a href="#module-system_timer">Modul: system_timer</a></li>
<li><strong>Datei:</strong> rtl/peripherals/uart.v</li>
<li><a href="#module-uart">Modul: uart</a></li>
<li><strong>Datei:</strong> rtl/peripherals/ws2812b.v</li>
<li><a href="#module-ws2812b">Modul: ws2812b</a></li>
<li><strong>Datei:</strong> rtl/register_file.v</li>
<li><a href="#module-register_file">Modul: register_file</a></li>
<li><strong>Datei:</strong> rtl/wgr_v_max.v</li>
<li><a href="#module-wgr_v_max">Modul: wgr_v_max</a></li>
</ul>
</div>
<div class="content">
<h2>Datei: rtl/alu.v</h2>
<h3 id="module-alu">Modul: alu</h3>
<p><strong>Kurzbeschreibung:</strong> Arithmetisch-Logische Einheit (ALU) für 32-Bit-Operationen.</p>
<p>Dieses Modul führt verschiedene arithmetische und logische Operationen auf zwei 32-Bit-Operanden durch, basierend auf einem 4-Bit-Steuersignal. Zusätzlich erzeugt es ein Zero-Flag, falls das Ergebnis 0 ist.  Unterstützte Operationen (OP_...): - ADD  (4'b0000) Addieren - SUB  (4'b0001) Subtrahieren - AND  (4'b0010) Bitwise UND - OR   (4'b0011) Bitwise ODER - XOR  (4'b0100) Bitwise EXKLUSIVE ODER - SLL  (4'b0101) Bitweises Shift-Left - SRL  (4'b0110) Bitweises Shift-Right (logisch) - SRA  (4'b0111) Vorzeichenbehaftetes, bitweises Shift-Right (arithmetisch) - SLT  (4'b1000) Vergleich (signed) - SLTU (4'b1001) Vergleich (unsigned)</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>OP_ADD</code>  = 4'b0000</li>
<li><code>OP_SUB</code>  = 4'b0001</li>
<li><code>OP_AND</code>  = 4'b0010</li>
<li><code>OP_OR</code>   = 4'b0011</li>
<li><code>OP_XOR</code>  = 4'b0100</li>
<li><code>OP_SLL</code>  = 4'b0101</li>
<li><code>OP_SRL</code>  = 4'b0110</li>
<li><code>OP_SRA</code>  = 4'b0111</li>
<li><code>OP_SLT</code>  = 4'b1000</li>
<li><code>OP_SLTU</code> = 4'b1001</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>[31:0]</code>     operand1 Erstes Eingangsoperand</li>
<li><code>[31:0]</code>     operand2 Zweites Eingangsoperand</li>
<li><code>[</code> 3:0]     operation 4-Bit-Operationscode</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>reg</code> [31:0] result Ergebnis des Rechenvorgangs</li>
<li><code>wire</code>       zero   Signal, falls result=0</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">alu</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">operand1</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">operand2</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">operation</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">zero</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Operationen als lokale Konstanten</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_ADD</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_SUB</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_AND</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_OR</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_XOR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_SLL</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_SRL</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_SRA</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_SLT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_SLTU</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Vorzeichenbehaftete Interpretionen der Operanden</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="k">signed</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">sign_op1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="k">signed</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">sign_op2</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sign_op1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">operand1</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sign_op2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">operand2</span><span class="p">);</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Hauptzuweisung für result abhängig von operation</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>

<span class="w">      </span><span class="nl">OP_ADD:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">operand1</span><span class="w">  </span><span class="o">+</span><span class="w">  </span><span class="n">operand2</span><span class="p">;</span>

<span class="w">      </span><span class="nl">OP_SUB:</span><span class="w"> </span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">sign_op1</span><span class="w">  </span><span class="o">-</span><span class="w">  </span><span class="n">sign_op2</span><span class="p">;</span>

<span class="w">      </span><span class="nl">OP_AND:</span><span class="w"> </span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">operand1</span><span class="w">  </span><span class="o">&amp;</span><span class="w">  </span><span class="n">operand2</span><span class="p">;</span>

<span class="w">      </span><span class="nl">OP_OR:</span><span class="w"> </span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">operand1</span><span class="w">  </span><span class="o">|</span><span class="w">  </span><span class="n">operand2</span><span class="p">;</span>

<span class="w">      </span><span class="nl">OP_XOR:</span><span class="w"> </span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">operand1</span><span class="w">  </span><span class="o">^</span><span class="w">  </span><span class="n">operand2</span><span class="p">;</span>

<span class="w">      </span><span class="nl">OP_SLL:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">operand1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="n">operand2</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="w">      </span><span class="nl">OP_SRL:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">operand1</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">operand2</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="w">      </span><span class="nl">OP_SRA:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">sign_op1</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">operand2</span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="w">      </span><span class="nl">OP_SLT:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sign_op1</span><span class="w">  </span><span class="o">&lt;</span><span class="w">  </span><span class="n">sign_op2</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">      </span><span class="nl">OP_SLTU:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">operand1</span><span class="w">  </span><span class="o">&lt;</span><span class="w">  </span><span class="n">operand2</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>


<span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">    </span><span class="k">endcase</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/cpu.v</h2>
<h3 id="module-cpu">Modul: cpu</h3>
<p><strong>Kurzbeschreibung:</strong> Einfacher CPU-Kern mit RISC-V-ähnlichem Befehlsformat.</p>
<p>Dieser CPU-Kern holt Instruktionen aus dem Speicher (memory), decodiert sie (Opcode, Funct3, Funct7, Registeradressen etc.) und führt sie mittels einer ALU aus. Lese- und Schreibzugriffe auf Speicher oder Peripherie erfolgen über die Signale <code>address</code>, <code>write_data</code>, <code>we</code>, <code>re</code>, <code>read_data</code> und <code>mem_busy</code>.  Der CPU-Core durchläuft eine einfache 5-stufige Pipeline in zeitversetzten Zuständen (FETCH, DECODE, EXECUTE, MEMORY, WRITEBACK), allerdings sequentiell (kein echtes Pipeline-Overlap).  Hier eine Kurzbeschreibung der Zustände: - FETCH  : Eine Instruktion wird über re=1 im Speicher angefordert. - WAIT   : Auf das Eintreffen von read_data wird gewartet. - DECODE : Instruktionsbits (opcode, funct3, funct7, rs1, rs2, rd usw.) extrahieren. - EXECUTE: ALU-Operationen durchführen, Sprungadressen berechnen usw. - MEMORY : Lese-/Schreibzugriffe bei LOAD/STORE - MEMHALT: Warten, bis der Speicher- oder Peripheriezugriff abgeschlossen ist. - RMW_WAIT &amp; STORE_RMW: Dienen dem atomaren Lesen-Schreiben (Byte/16-Bit) bei LOAD/STORE. - WRITEBACK: Ergebnis in Register ablegen (falls erforderlich) und PC inkrementieren oder Branch ausführen.   Die ALU-Operationen nutzen ein 4-Bit-Steuersignal (z. B. OP_ADD), das anhand von opcode/funct3/funct7 generiert wird.</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>FETCH</code>    = 4'd0</li>
<li><code>WAIT</code>     = 4'd1</li>
<li><code>DECODE</code>   = 4'd2</li>
<li><code>EXECUTE</code>  = 4'd3</li>
<li><code>MEMORY</code>   = 4'd4</li>
<li><code>MEMHALT</code>  = 4'd5</li>
<li><code>WRITEBACK=</code> 4'd6</li>
<li><code>RMW_WAIT</code> = 4'd7</li>
<li><code>STORE_RMW=</code> 4'd8</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>                   Systemtakt</li>
<li><code>rst_n</code>                 Asynchroner, aktiver-LOW Reset</li>
<li><code>[31:0]</code>     read_data  Daten, die bei re=1 aus dem Speicher gelesen werden</li>
<li><code>wire</code>       mem_busy   Signalisiert, ob der Speicherzugriff noch in Arbeit ist</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code>     address    Speicheradresse für Lese-/Schreiboperationen</li>
<li><code>reg</code> [31:0] write_data Daten, die bei we=1 in den Speicher geschrieben werden</li>
<li><code>reg</code>        we         Write-Enable</li>
<li><code>reg</code>        re         Read-Enable</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>




<span class="k">module</span><span class="w"> </span><span class="n">cpu</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">mem_busy</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Definition der Zustände / 5-stufige Pipeline</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">FETCH</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">,</span>
<span class="w">    </span><span class="n">WAIT</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">,</span>
<span class="w">    </span><span class="n">DECODE</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d2</span><span class="p">,</span>
<span class="w">    </span><span class="n">EXECUTE</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="p">,</span>
<span class="w">    </span><span class="n">MEMORY</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="p">,</span>
<span class="w">    </span><span class="n">MEMHALT</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d5</span><span class="p">,</span>
<span class="w">    </span><span class="n">WRITEBACK</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d6</span><span class="p">,</span>
<span class="w">    </span><span class="n">RMW_WAIT</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="p">,</span>
<span class="w">    </span><span class="n">STORE_RMW</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d8</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// ALU-Operationscodes</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">OP_ADD</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_SUB</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_AND</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0010</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_OR</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0011</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_XOR</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0100</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_SLL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0101</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_SRL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0110</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_SRA</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0111</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_SLT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1000</span><span class="p">,</span>
<span class="w">    </span><span class="n">OP_SLTU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1001</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Funct3-Codes</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">F3_ADD_SUB</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_SLL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_SLT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_SLTU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b011</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_XOR</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_SRL_SRA</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_OR</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_AND</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="p">;</span>

<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">F3_LB</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_LH</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_LW</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_LBU</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_LHU</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">;</span>

<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">F3_SB</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_SH</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_SW</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b010</span><span class="p">;</span>

<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">F3_BEQ</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_BNE</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b001</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_BLT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b100</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_BGE</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b101</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_BLTU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b110</span><span class="p">,</span>
<span class="w">    </span><span class="n">F3_BGEU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b111</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Funct7 / OPCODE</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">F7_ADD</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_SUB</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0100000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_SLL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_SLT</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_SLTU</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_XOR</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_SRL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_SRA</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0100000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_OR</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">,</span>
<span class="w">    </span><span class="n">F7_AND</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000000</span><span class="p">;</span>

<span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>
<span class="w">    </span><span class="n">OPCODE_LUI</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0110111</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_AUIPC</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0010111</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_JAL</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1101111</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_JALR</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1100111</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_BRANCH</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b1100011</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_LOAD</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000011</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_STORE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0100011</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_OP_IMM</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0010011</span><span class="p">,</span>
<span class="w">    </span><span class="n">OPCODE_OP</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0110011</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// CPU-Register (PC, Zwischenspeicher etc.)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">PC</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">inst</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address_reg</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_w_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">alu_operand1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">alu_operand2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">reg_write_addr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">alu_op</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">next_state</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem_offset</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">reg_we</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// ALU-Anbindung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">alu_result</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">funct7</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">funct3</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">alu_zero</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zuweisungen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address_reg</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="w"> </span><span class="mh">6</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">funct7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">25</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rs1</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">15</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rs2</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="mh">20</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rd</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="w"> </span><span class="mh">7</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">funct3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">12</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Registerdatei-Instanzierung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">register_file</span><span class="w"> </span><span class="n">reg_file</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">     </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">       </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">        </span><span class="p">(</span><span class="n">reg_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rd</span><span class="w">        </span><span class="p">(</span><span class="n">reg_write_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rs1</span><span class="w">       </span><span class="p">(</span><span class="n">rs1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rs2</span><span class="w">       </span><span class="p">(</span><span class="n">rs2</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rd_data</span><span class="w">   </span><span class="p">(</span><span class="n">reg_w_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rs1_data</span><span class="w">  </span><span class="p">(</span><span class="n">rs1_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rs2_data</span><span class="w">  </span><span class="p">(</span><span class="n">rs2_data</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// ALU-Instanzierung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">alu</span><span class="w"> </span><span class="n">alu_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">operand1</span><span class="w">  </span><span class="p">(</span><span class="n">alu_operand1</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">operand2</span><span class="w">  </span><span class="p">(</span><span class="n">alu_operand2</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">operation</span><span class="w"> </span><span class="p">(</span><span class="n">alu_op</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">result</span><span class="w">    </span><span class="p">(</span><span class="n">alu_result</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">zero</span><span class="w">      </span><span class="p">(</span><span class="n">alu_zero</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Erzeugung von &#39;imm&#39; aus der Instruktion (verschiedene Typen)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span>

<span class="w">      </span><span class="n">OPCODE_OP_IMM</span><span class="p">,</span>
<span class="w">      </span><span class="n">OPCODE_LOAD</span><span class="p">,</span>
<span class="w">      </span><span class="nl">OPCODE_JALR:</span><span class="w"> </span>
<span class="w">        </span><span class="c1">// Sign extension für 12-Bit</span>
<span class="w">        </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">20</span><span class="p">]};</span>

<span class="w">      </span><span class="nl">OPCODE_STORE:</span>
<span class="w">        </span><span class="c1">// Sign extension für 12-Bit (Split in inst[31:25] &amp; inst[11:7])</span>
<span class="w">        </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="mh">7</span><span class="p">]};</span>

<span class="w">      </span><span class="nl">OPCODE_BRANCH:</span>
<span class="w">        </span><span class="c1">// Sign extension + Bit[7] + Bit[30:25] + Bit[11:8] + 0</span>
<span class="w">        </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">20</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">7</span><span class="p">],</span><span class="w"> </span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">25</span><span class="p">],</span><span class="w"> </span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">11</span><span class="o">:</span><span class="w"> </span><span class="mh">8</span><span class="p">],</span><span class="w"> </span>
<span class="w">                   </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span>

<span class="w">      </span><span class="n">OPCODE_LUI</span><span class="p">,</span>
<span class="w">      </span><span class="nl">OPCODE_AUIPC:</span>
<span class="w">        </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="w"> </span><span class="mh">12</span><span class="p">],</span><span class="w"> </span><span class="mh">12</span><span class="mb">&#39;b0</span><span class="p">};</span>

<span class="w">      </span><span class="nl">OPCODE_JAL:</span>
<span class="w">        </span><span class="c1">// 20-Bit Sign extension, plus die gemischten Bits (inst[31], inst[19:12], inst[20], inst[30:21], 0)</span>
<span class="w">        </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">11</span><span class="p">{</span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">31</span><span class="p">],</span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">19</span><span class="o">:</span><span class="mh">12</span><span class="p">],</span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">20</span><span class="p">],</span>
<span class="w">                   </span><span class="n">inst</span><span class="p">[</span><span class="mh">30</span><span class="o">:</span><span class="mh">21</span><span class="p">],</span>
<span class="w">                   </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span>

<span class="w">      </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">imm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">    </span><span class="k">endcase</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Nächster Zustand (next_state) basierend auf state + Signalen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">      </span><span class="nl">FETCH:</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WAIT</span><span class="p">;</span>

<span class="w">      </span><span class="nl">WAIT:</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">WAIT</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">DECODE</span><span class="p">;</span>

<span class="w">      </span><span class="nl">DECODE:</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXECUTE</span><span class="p">;</span>

<span class="w">      </span><span class="nl">EXECUTE:</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="c1">// Bei LOAD/STORE -&gt; in den MEMORY-Zustand</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_LOAD</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_STORE</span><span class="p">)</span>
<span class="w">          </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MEMORY</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRITEBACK</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="nl">MEMORY:</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_LOAD</span><span class="p">)</span>
<span class="w">          </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">MEMORY</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MEMHALT</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_STORE</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SW</span><span class="p">)</span>
<span class="w">              </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">MEMORY</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MEMHALT</span><span class="p">;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="c1">// Byte/Halfword =&gt; Read-Modify-Write</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SB</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SH</span><span class="p">)</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">MEMORY</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">RMW_WAIT</span><span class="p">;</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">                </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">MEMORY</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MEMHALT</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WRITEBACK</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="nl">RMW_WAIT:</span>
<span class="w">        </span><span class="c1">// Warte auf Ende des Speicherzugriffs</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">RMW_WAIT</span><span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">STORE_RMW</span><span class="p">;</span>
<span class="w">      </span><span class="nl">STORE_RMW:</span>
<span class="w">        </span><span class="c1">// Warte erneut bis busy + re/we durch sind</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">STORE_RMW</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MEMHALT</span><span class="p">;</span>
<span class="w">      </span><span class="nl">MEMHALT:</span>
<span class="w">        </span><span class="c1">// Warte bis busy und re/we beendet</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mem_busy</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">MEMHALT</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">WRITEBACK</span><span class="p">;</span>
<span class="w">      </span><span class="nl">WRITEBACK:</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FETCH</span><span class="p">;</span>
<span class="w">      </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">next_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FETCH</span><span class="p">;</span>

<span class="w">    </span><span class="k">endcase</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustandsübergänge und Ausführung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">FETCH</span><span class="p">;</span>
<span class="w">      </span><span class="n">PC</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h00004000</span><span class="p">;</span><span class="w"> </span><span class="c1">// Startadresse</span>
<span class="w">      </span><span class="n">inst</span><span class="w">        </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h00000013</span><span class="p">;</span>
<span class="w">      </span><span class="n">reg_we</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">re</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">we</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">write_data</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">address_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h00004000</span><span class="p">;</span>
<span class="w">      </span><span class="n">mem_offset</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">next_state</span><span class="p">;</span>
<span class="w">      </span><span class="n">reg_we</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w">  </span><span class="c1">// Standard: kein Registerwrite</span>
<span class="w">      </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Standard: Kein Schreiben</span>
<span class="w">      </span><span class="n">re</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">we</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// FETCH: Instruktion anfordern (re=1, address=PC)</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">FETCH:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">re</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">address_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// WAIT: Warten auf read_data vom Speicher</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">WAIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">re</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>


<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// DECODE: Instruktion in &#39;inst&#39; puffer, parse</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">DECODE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">inst</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// EXECUTE: Berechne ALU-Operation (ALU-Setup)</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">EXECUTE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span>

<span class="w">            </span><span class="nl">OPCODE_OP:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">;</span>

<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="p">)</span>

<span class="w">                </span><span class="nl">F3_ADD_SUB:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">funct7</span><span class="p">[</span><span class="mh">5</span><span class="p">]</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">OP_SUB</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_AND:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_AND</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_OR:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_OR</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_XOR:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_XOR</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SLL:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SLL</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SRL_SRA:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">funct7</span><span class="p">[</span><span class="mh">5</span><span class="p">]</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">OP_SRA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">OP_SRL</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SLT:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SLT</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SLTU:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SLTU</span><span class="p">;</span>

<span class="w">                </span><span class="k">default</span><span class="o">:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span><span class="w"> </span><span class="c1">//NOP ausführen</span>

<span class="w">              </span><span class="k">endcase</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_OP_IMM:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SLL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SRL_SRA</span><span class="p">)</span>
<span class="w">                </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">inst</span><span class="p">[</span><span class="mh">24</span><span class="o">:</span><span class="w"> </span><span class="mh">20</span><span class="p">];</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">                </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>

<span class="w">              </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="p">)</span>

<span class="w">                </span><span class="nl">F3_ADD_SUB:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_AND:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_AND</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_OR:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_OR</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_XOR:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_XOR</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SLT:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SLT</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SLTU:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SLTU</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SLL:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SLL</span><span class="p">;</span>

<span class="w">                </span><span class="nl">F3_SRL_SRA:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="mh">30</span><span class="p">])</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">OP_SRA</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">OP_SRL</span><span class="p">;</span>

<span class="w">                </span><span class="k">default</span><span class="o">:</span>
<span class="w">                  </span><span class="n">alu_op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>

<span class="w">              </span><span class="k">endcase</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_LOAD:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_STORE:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">           </span><span class="nl">OPCODE_JAL:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_JALR:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_BRANCH:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_SUB</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_AUIPC:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="nl">OPCODE_LUI:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">OP_ADD</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">alu_operand1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_operand2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">              </span><span class="n">alu_op</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1111</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">          </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// MEMORY: Lese-/Schreibzugriff</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">MEMORY:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_LOAD</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">re</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">            </span><span class="n">address_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">32&#39;hFFFFFFFC</span><span class="p">;</span>
<span class="w">            </span><span class="n">mem_offset</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">];</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_STORE</span><span class="p">)</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SW</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">write_data</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">;</span>
<span class="w">                </span><span class="n">we</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                </span><span class="n">address_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SB</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SH</span><span class="p">)</span>
<span class="w">                </span><span class="k">begin</span>
<span class="w">                  </span><span class="n">re</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                  </span><span class="n">address_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">32&#39;hFFFFFFFC</span><span class="p">;</span>
<span class="w">                  </span><span class="n">mem_offset</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// RMW_WAIT: Warten bis read_data ok</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">RMW_WAIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="c1">// Warten bis read_data ok</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// STORE_RMW: Daten anpassen und we=1</span>
<span class="w">        </span><span class="c1">// Byte-/Halbwort-Schreiben erfordert zuerst ein Lesen des Zielwortes (Read-Modify-Write)</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">STORE_RMW:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SB</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">mem_offset</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">])</span>

<span class="w">              </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">8</span><span class="p">],</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>

<span class="w">              </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">],</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]};</span>

<span class="w">              </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">],</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]};</span>

<span class="w">              </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">rs2_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>

<span class="w">              </span><span class="k">default</span><span class="o">:</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>

<span class="w">            </span><span class="k">endcase</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F3_SH</span><span class="p">)</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mem_offset</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="w"> </span><span class="mh">16</span><span class="p">],</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]};</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">                </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">rs2_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]};</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">              </span><span class="n">write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>

<span class="w">          </span><span class="n">we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// MEMHALT: Warte auf Freigabe</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">MEMHALT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="c1">// wait</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// WRITEBACK: ALU-Ergebnis oder Speicherergebnisse</span>
<span class="w">        </span><span class="c1">//            in Register ablegen. PC update.</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">WRITEBACK:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">7</span><span class="mb">&#39;b0000011</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="p">)</span>

<span class="w">              </span><span class="nl">F3_LB:</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">mem_offset</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">])</span>
<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span><span class="w">   </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="p">]}},</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]};</span>
<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span><span class="w">   </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="p">]}},</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">8</span><span class="p">]};</span>
<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span><span class="w">   </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">23</span><span class="p">]}},</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>
<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span><span class="w">   </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{{</span><span class="mh">24</span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">]};</span>
<span class="w">                  </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>
<span class="w">                </span><span class="k">endcase</span>
<span class="w">              </span><span class="k">end</span>

<span class="w">              </span><span class="nl">F3_LH:</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mem_offset</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span>
<span class="w">                  </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{{</span><span class="mh">16</span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="p">]}},</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                  </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{{</span><span class="mh">16</span><span class="p">{</span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="p">]}},</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>
<span class="w">              </span><span class="k">end</span>

<span class="w">              </span><span class="nl">F3_LW:</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>

<span class="w">              </span><span class="nl">F3_LBU:</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">mem_offset</span><span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">])</span>

<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span>
<span class="w">                    </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>

<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span>
<span class="w">                    </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">]};</span>

<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span>
<span class="w">                    </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>

<span class="w">                  </span><span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span>
<span class="w">                    </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">24</span><span class="p">]};</span>

<span class="w">                  </span><span class="k">default</span><span class="o">:</span>
<span class="w">                    </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>

<span class="w">                </span><span class="k">endcase</span>
<span class="w">              </span><span class="k">end</span>

<span class="w">              </span><span class="nl">F3_LHU:</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mem_offset</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span>
<span class="w">                  </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]};</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                  </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">read_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">]};</span>
<span class="w">              </span><span class="k">end</span>

<span class="w">              </span><span class="k">default</span><span class="o">:</span>
<span class="w">                </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>

<span class="w">            </span><span class="k">endcase</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_JAL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">                   </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_JALR</span><span class="p">)</span>
<span class="w">            </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">;</span>

<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_LUI</span><span class="p">)</span>
<span class="w">            </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>

<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_AUIPC</span><span class="p">)</span>
<span class="w">            </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">;</span>

<span class="w">          </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_OP_IMM</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>
<span class="w">                   </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_OP</span><span class="p">)</span>
<span class="w">            </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="p">;</span>

<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">reg_w_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// Bei bestimmten Opcodes muss in rd geschrieben werden</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_LOAD</span><span class="w">  </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_JAL</span><span class="w">    </span><span class="o">||</span>
<span class="w">              </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_JALR</span><span class="w">  </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_LUI</span><span class="w">    </span><span class="o">||</span>
<span class="w">              </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_AUIPC</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_OP_IMM</span><span class="w"> </span><span class="o">||</span>
<span class="w">              </span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_OP</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">reg_write_addr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
<span class="w">            </span><span class="n">reg_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="p">);</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">reg_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">          </span><span class="c1">// PC-Update</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_JAL</span><span class="p">)</span>
<span class="w">            </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="p">;</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_JALR</span><span class="p">)</span>
<span class="w">              </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">alu_result</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">~</span><span class="mh">32</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OPCODE_BRANCH</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">funct3</span><span class="p">)</span>

<span class="w">                  </span><span class="nl">F3_BEQ:</span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">alu_zero</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">);</span>

<span class="w">                  </span><span class="nl">F3_BNE:</span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">alu_zero</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">);</span>

<span class="w">                  </span><span class="nl">F3_BLT:</span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">rs1_data</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">rs2_data</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">);</span>

<span class="w">                  </span><span class="nl">F3_BGE:</span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">rs1_data</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">rs2_data</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">);</span>

<span class="w">                  </span><span class="nl">F3_BLTU:</span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">rs1_data</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">);</span>

<span class="w">                  </span><span class="nl">F3_BGEU:</span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">rs1_data</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">rs2_data</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">imm</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">);</span>

<span class="w">                  </span><span class="k">default</span><span class="o">:</span><span class="w"> </span>
<span class="w">                    </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">;</span>

<span class="w">                </span><span class="k">endcase</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">                </span><span class="n">PC</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">PC</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/defines.v</h2>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Globale Definitionsdatei (Makros und Parameter).</p>
<p>Diese Datei definiert verschiedene globale Konstante, Parameter und Makros, die in den restlichen Modulen verwendet werden. Sie legt unter anderem die Taktfrequenz (<code>CLK_FREQ</code>), UART- und SPI-FIFO-Größen fest, sowie Flags zum Bedingten Integrieren bestimmter Module (z. B. <code>INCLUDE_UART</code>).</p>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Gibt die Taktfrequenz des Systems in Hz an, z. B. 12 MHz.</p>
<p>module defines</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>CLK_FREQ</code></li>
</ul>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Berechnet den Teilerwert für eine angegebene Baudrate.</p>
<p>module defines Beispiel: <code>BAUD_DIV(115200)</code> bei 12 MHz ergibt den passenden Teilwert.</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>BAUD_DIV(Baud)</code></li>
</ul>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Aktiviert (falls definiert) den Betrieb als 32-Bit RISC-V-Kern.</p>
<p>module defines</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>RV32I</code></li>
</ul>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Aktiviert (falls definiert) die Verwendung des FRAM-Speichers statt internem RAM.</p>
<p>module defines</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>FRAM_MEMORY</code></li>
</ul>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Legt die Tiefe (Anzahl Einträge) für die TX- und RX-FIFOs des UART fest.</p>
<p>module defines</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>UART_FIFO_TX_DEPTH</code></li>
<li><code>UART_FIFO_RX_DEPTH</code></li>
</ul>
<h3 id="module-defines">Modul: defines</h3>
<p><strong>Kurzbeschreibung:</strong> Legt die Tiefe (Anzahl Einträge) für die TX- und RX-FIFOs des SPI fest.</p>
<p>module defines</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>SPI_FIFO_TX_DEPTH</code></li>
<li><code>SPI_FIFO_RX_DEPTH</code></li>
</ul>
<h3 id="module-unknown">Modul: Unknown</h3>
<p><strong>Kurzbeschreibung:</strong> Schalter zum bedingten Einbinden der jeweiligen Peripheriemodule.</p>
<p>module defines</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>INCLUDE_DEBUG,</code> INCLUDE_UART, INCLUDE_TIME, ...</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`ifndef</span><span class="w"> </span><span class="n">DEFINES_V</span>
<span class="cp">`define DEFINES_V</span>




<span class="cp">`define CLK_FREQ       12_000_000</span>


<span class="cp">`define BAUD_DIV(Baud) ((`CLK_FREQ / Baud) - 1)</span>


<span class="cp">`define RV32I</span>


<span class="c1">//`define FRAM_MEMORY</span>


<span class="cp">`define UART_FIFO_TX_DEPTH 4</span>
<span class="cp">`define UART_FIFO_RX_DEPTH 4</span>


<span class="cp">`define SPI_FIFO_TX_DEPTH 4</span>
<span class="cp">`define SPI_FIFO_RX_DEPTH 4</span>


<span class="cp">`define INCLUDE_DEBUG</span>
<span class="cp">`define INCLUDE_UART</span>
<span class="cp">`define INCLUDE_TIME</span>
<span class="cp">`define INCLUDE_PWM</span>
<span class="cp">`define INCLUDE_MULT</span>
<span class="cp">`define INCLUDE_DIV</span>
<span class="cp">`define INCLUDE_SPI</span>
<span class="cp">`define INCLUDE_GPIO</span>
<span class="cp">`define INCLUDE_WS</span>

<span class="no">`endif</span>
</code></pre></div>


</details>

<h2>Datei: rtl/fram/fram_ram.v</h2>
<h3 id="module-fram_ram">Modul: fram_ram</h3>
<p><strong>Kurzbeschreibung:</strong> Abstraktes FRAM-Zugriffsmodul, das nach außen wie RAM erscheint,</p>
<p>intern jedoch über SPI kommuniziert.  Dieses Modul nimmt Lese- und Schreibanforderungen (über address, we, re) entgegen und leitet sie an das <code>fram_spi</code>-Modul weiter. Nach Abschluss der SPI-Operation wird <code>read_data</code> gültig, bzw. die Schreiboperation ist abgeschlossen. Ein <code>req_ready</code>-Signal zeigt an, wann das Modul wieder bereit für neue Befehle ist.   entgegen genommen werden kann</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>ST_IDLE</code>  Leerlaufzustand (wartet auf we/re)</li>
<li><code>ST_START</code> Vorbereitung der SPI-Operation (Adress-/Datenübergabe)</li>
<li><code>ST_WAIT</code>  Wartezustand, bis <code>fram_spi</code> fertigsignalisiert</li>
<li><code>ST_DONE</code>  Abschluss der Operation, Daten liegen vor, req_ready=1</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt</li>
<li><code>rst_n</code>             Asynchrones, aktives-LOW Reset</li>
<li><code>[15:0]</code> address    Adress-Eingang (16 Bit, FRAM-Adressbereich)</li>
<li><code>[31:0]</code> write_data Daten, die bei we=1 in den FRAM geschrieben werden</li>
<li><code>we</code>                Schreibeaktivierung (Write Enable)</li>
<li><code>re</code>                Leseaktivierung (Read Enable)</li>
<li><code>spi_miso</code>          SPI-Eingang (Master In, Slave Out)</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>reg</code> req_ready     Signal, das anzeigt, ob ein neuer Lese-/Schreibzugriff</li>
<li><code>reg</code> [31:0]        read_data  Ausgelesene Daten bei einem Lesezugriff</li>
<li><code>spi_mosi</code>          SPI-Ausgang (Master Out, Slave In)</li>
<li><code>spi_clk</code>           SPI-Taktleitung</li>
<li><code>spi_cs</code>            SPI-Chip-Select</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">fram_ram</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">req_ready</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_cs</span><span class="p">,</span>
<span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustandsdefinitionen für die interne Steuerung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_START</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WAIT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_DONE</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d3</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Registervariablen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_write_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">lat_write_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_address</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">lat_address</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">         </span><span class="n">latched_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_re</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Rückgabedaten und Status von fram_spi</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_read_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_done</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Instanzierung des FRAM-SPI-Moduls</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">fram_spi</span><span class="w"> </span><span class="n">fram_spi_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">         </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">       </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">     </span><span class="p">(</span><span class="n">spi_address</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w">  </span><span class="p">(</span><span class="n">spi_write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">   </span><span class="p">(</span><span class="n">spi_read_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">          </span><span class="p">(</span><span class="n">spi_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">          </span><span class="p">(</span><span class="n">spi_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">done</span><span class="w">        </span><span class="p">(</span><span class="n">spi_done</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_mosi</span><span class="w">    </span><span class="p">(</span><span class="n">spi_mosi</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_miso</span><span class="w">    </span><span class="p">(</span><span class="n">spi_miso</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_clk</span><span class="w">     </span><span class="p">(</span><span class="n">spi_clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_cs</span><span class="w">      </span><span class="p">(</span><span class="n">spi_cs</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustandsmaschine zur Abwicklung eines Lese-/Schreibzugriffs</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>
<span class="w">      </span><span class="n">req_ready</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">latched_we</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">lat_address</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">lat_write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">read_data</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_re</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_we</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_address</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">spi_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_re</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_IDLE: Warten auf we oder re</span>
<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_IDLE:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">re</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">lat_address</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">            </span><span class="n">lat_write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">            </span><span class="n">latched_we</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">we</span><span class="p">;</span>
<span class="w">            </span><span class="n">req_ready</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_START</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">req_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>


<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_START: Setze Parameter für fram_spi</span>
<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_START:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_address</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">lat_address</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_write_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">lat_write_data</span><span class="p">;</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latched_we</span><span class="p">)</span><span class="w"> </span>
<span class="w">            </span><span class="n">spi_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">else</span><span class="w"> </span>
<span class="w">            </span><span class="n">spi_re</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>

<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WAIT</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WAIT: Warten, bis fram_spi fertig signalisiert (spi_done)</span>
<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WAIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_done</span><span class="p">)</span><span class="w"> </span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">latched_we</span><span class="p">)</span><span class="w"> </span>
<span class="w">              </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">spi_read_data</span><span class="p">;</span>

<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_DONE</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_DONE: Vorgang abgeschlossen, req_ready = 1</span>
<span class="w">        </span><span class="c1">// ---------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_DONE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">req_ready</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">state</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/fram/fram_spi.v</h2>
<h3 id="module-fram_spi">Modul: fram_spi</h3>
<p><strong>Kurzbeschreibung:</strong> SPI-Steuerung für FRAM-Zugriffe.</p>
<p>Dieses Modul erzeugt eine sequenzielle SPI-Kommunikation mit einem FRAM-Baustein (z. B. MB85RS64V). Es verwendet Opcode-Sequenzen für das Aktivieren der Schreibberechtigung (WREN), das Schreiben (WRITE) und das Lesen (READ). Die Operation wird anhand der Signale <code>we</code>, <code>re</code>, <code>address</code>, <code>write_data</code> gestartet. Nach Abschluss meldet das Modul den Zustand mit <code>done</code>.</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>CMD_WIDTH</code>       Anzahl der zu shiftenden Bits für WRITE/READ (Adresse + Daten)</li>
<li><code>CMD_WIDTH_WREN</code>  Anzahl der Bits für OPCODE_WREN</li>
</ul>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>OPCODE_WREN</code>    SPI-Opcode zum Aktivieren des Schreibens</li>
<li><code>OPCODE_WRITE</code>   SPI-Opcode zum Schreiben von Daten</li>
<li><code>OPCODE_READ</code>    SPI-Opcode zum Lesen von Daten</li>
<li><code>ST_IDLE</code>        Leerlaufzustand (wartet auf we/re)</li>
<li><code>ST_WREN_INIT</code>   Start der WREN-Sequenz</li>
<li><code>ST_WREN_SHIFT</code>  Shiften der WREN-Bits</li>
<li><code>ST_WREN_DONE</code>   Abschluss der WREN-Operation</li>
<li><code>ST_WRITE_INIT</code>  Start der WRITE-Operation</li>
<li><code>ST_WRITE_SHIFT</code> Shiften der Schreibdaten</li>
<li><code>ST_WRITE_DONE</code>  Abschluss der Schreiboperation</li>
<li><code>ST_READ_INIT</code>   Start der READ-Operation</li>
<li><code>ST_READ_SHIFT</code>  Shiften der gelesenen Daten</li>
<li><code>ST_READ_DONE</code>   Abschluss der Leseoperation</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt</li>
<li><code>rst_n</code>             Asynchrones, aktives-LOW Reset</li>
<li><code>[15:0]</code> address    Zieladresse (für WRITE/READ)</li>
<li><code>[31:0]</code> write_data Zu schreibende 32-Bit-Daten</li>
<li><code>we</code>                Write-Enable (löst WRITE-Sequenz aus)</li>
<li><code>re</code>                Read-Enable  (löst READ-Sequenz aus)</li>
<li><code>wire</code>              spi_miso  SPI-Datenleitung Slave-&gt;Master</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>reg</code> [31:0]        read_data Ausgelesene 32-Bit-Daten</li>
<li><code>reg</code>               done      Signalisiert Abschluss einer Operation</li>
<li><code>reg</code>               spi_mosi  SPI-Datenleitung Master-&gt;Slave</li>
<li><code>reg</code>               spi_clk   SPI-Takt</li>
<li><code>reg</code>               spi_cs    SPI-Chip-Select (aktiv LOW)</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">fram_spi</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">done</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_cs</span>
<span class="p">);</span><span class="w"> </span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lokale Parameter (OPCODEs)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">OPCODE_WREN</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h06</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">OPCODE_WRITE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h02</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">OPCODE_READ</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h03</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustände des internen State-Automaten</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WREN_INIT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WREN_SHIFT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WREN_DONE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WRITE_INIT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WRITE_SHIFT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d5</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_WRITE_DONE</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d6</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_READ_INIT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_READ_SHIFT</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d8</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ST_READ_DONE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d9</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Anzahl der zu shiftenden Bits:</span>
<span class="w">  </span><span class="c1">// - CMD_WIDTH: 8 (Opcode) + 16 (Adresse) + 32 (Daten) = 56</span>
<span class="w">  </span><span class="c1">// - CMD_WIDTH_WREN: 8 (nur Opcode WREN)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CMD_WIDTH</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="mh">56</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CMD_WIDTH_WREN</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">8</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Registervariablen für Shift und Steuerung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">55</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_count</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">spi_clk_en</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">shifting</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// SPI-Taktdesign: spi_sck (genannt spi_clk)</span>
<span class="w">  </span><span class="c1">// Wenn spi_clk_en=1, toggelt spi_clk</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">      </span><span class="n">spi_sck</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_clk_en</span><span class="p">)</span>
<span class="w">        </span><span class="n">spi_sck</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">~</span><span class="n">spi_sck</span><span class="p">;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">spi_sck</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Hauptzustandsmaschine: WREN -&gt; WRITE oder READ</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>
<span class="w">      </span><span class="n">done</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_count</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_cs</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_mosi</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">read_data</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">shift_reg</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">56</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">done</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_IDLE: Warten auf we (WRITE) oder re (READ)</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_IDLE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">bit_count</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">write_enable</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">shift_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">OPCODE_WREN</span><span class="p">,</span><span class="w"> </span><span class="mh">48</span><span class="mi">&#39;d0</span><span class="p">};</span>
<span class="w">            </span><span class="n">state</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WREN_INIT</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_enable</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">shift_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">OPCODE_READ</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">};</span>
<span class="w">            </span><span class="n">state</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_READ_INIT</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WREN_INIT: CS low, shift_reg bereit für WREN</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WREN_INIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">bit_count</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_mosi</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">55</span><span class="p">];</span>
<span class="w">          </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WREN_SHIFT</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WREN_SHIFT: Schiebe 8 Bit des WREN-Opcode raus</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WREN_SHIFT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CMD_WIDTH_WREN</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">            </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WREN_DONE</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WREN_DONE: Jetzt WRITE vorbereiten</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WREN_DONE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">shift_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">OPCODE_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">write_data</span><span class="p">};</span>
<span class="w">          </span><span class="n">state</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WRITE_INIT</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WRITE_INIT: CS wieder runter, neu schieben</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WRITE_INIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">bit_count</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_mosi</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">55</span><span class="p">];</span>
<span class="w">          </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WRITE_SHIFT</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WRITE_SHIFT: 56 Bit (8+16+32) werden geshiftet</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WRITE_SHIFT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CMD_WIDTH</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">            </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_WRITE_DONE</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_WRITE_DONE: Fertig, done=1</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_WRITE_DONE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">done</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_READ_INIT: CS runter, shift_reg bereit (OPCODE+Adress+Dummy)</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_READ_INIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">bit_count</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_mosi</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">55</span><span class="p">];</span>
<span class="w">          </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_READ_SHIFT</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_READ_SHIFT: 56 Bit werden geshiftet, wobei</span>
<span class="w">        </span><span class="c1">//   die letzten 32 Bits Daten vom FRAM sind.</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_READ_SHIFT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CMD_WIDTH</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">spi_cs</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">            </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">shifting</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_READ_DONE</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="c1">// ST_READ_DONE: Aus shift_reg die empfangenen 32 Bits</span>
<span class="w">        </span><span class="c1">// -------------------------------------------------</span>
<span class="w">        </span><span class="nl">ST_READ_DONE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">          </span><span class="n">done</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ST_IDLE</span><span class="p">;</span>
<span class="w">      </span><span class="k">endcase</span>

<span class="w">      </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">      </span><span class="c1">// Schiebe-Operation</span>
<span class="w">      </span><span class="c1">// Bei jeder fallenden Flanke von spi_clk: shift_reg[0] &lt;= spi_miso</span>
<span class="w">      </span><span class="c1">// Bei jeder steigenden Flanke: shift_reg &lt;&lt; 1</span>
<span class="w">      </span><span class="c1">// Hier realisiert über spi_sck == 0 / == 1-Abfragen</span>
<span class="w">      </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shifting</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_sck</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">)</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">shift_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">54</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">          </span><span class="n">bit_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">spi_miso</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="n">spi_mosi</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">55</span><span class="p">];</span>

<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/fram/mb85rs64v.v</h2>
<h3 id="module-mb85rs64v">Modul: mb85rs64v</h3>
<p><strong>Kurzbeschreibung:</strong> Verilog-Modell des FRAM-Bausteins MB85RS64V.</p>
<p>Dieses Modul simuliert den internen SPI-Verhaltensablauf des MB85RS64V-Fram-Speichers. Es reagiert auf die üblichen FRAM-OPCODES (WRITE, READ, WREN) und unterstützt das Speichern von Daten in einem internen Memory-Array. Das Modul ist nur für Simulation und Verifikationszwecke gedacht und ersetzt in der Hardware ein externes FRAM-Bauteil.  Zustandsautomat: - STATE_OPCODE:     Auswerten des eingehenden Opcodes (WREN, WRITE, READ) - STATE_ADDR:       Erfassen der Adresse (2 Bytes) - STATE_WRITE_DATA: Schreiben der ankommenden Bytes in Memory - STATE_READ_DATA:  Ausgeben der gewünschten Bytes aus Memory</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>OP_WRITE</code>         SPI-Opcode für Schreibzugriff</li>
<li><code>OP_READ</code>          SPI-Opcode für Lesezugriff</li>
<li><code>OP_WREN</code>          SPI-Opcode für Write Enable</li>
<li><code>STATE_OPCODE</code>     Zustand zum Erfassen des Opcodes</li>
<li><code>STATE_ADDR</code>       Zustand zum Erfassen der Adresse</li>
<li><code>STATE_WRITE_DATA</code> Zustand zum Schreiben der Daten ins Memory</li>
<li><code>STATE_READ_DATA</code>  Zustand zum Auslesen der Daten</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>          Systemtakt</li>
<li><code>rst_n</code>        Asynchrones, aktives-LOW Reset</li>
<li><code>spi_mosi</code>     SPI-Datenleitung Master-&gt;Slave</li>
<li><code>spi_clk</code>      SPI-Takt</li>
<li><code>spi_cs</code>       SPI-Chip-Select (aktiv LOW)</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>reg</code> spi_miso SPI-Datenleitung Slave-&gt;Master</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">mb85rs64v</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_cs</span>
<span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lokale Konstanten / OPCODES</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_WRITE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h02</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_READ</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h03</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">OP_WREN</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h06</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustandsdefinitionen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_OPCODE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_ADDR</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_WRITE_DATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_READ_DATA</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Internes Memory-Array (z. B. 8k x 8 Bit = 64 KBit)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">8191</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Registervariablen für OPCODE, Adresse, Daten etc.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address_shift</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">opcode_shift</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_reg</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">data_shift</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_cnt_tx</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_cnt_rx</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">spi_clk_prev</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">cs_prev</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">wel</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// SPI-Signal-Flankenerkennung</span>
<span class="w">  </span><span class="c1">// - spi_clk_prev, cs_prev merken letzten Zustand</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_OPCODE</span><span class="p">;</span>
<span class="w">      </span><span class="n">opcode</span><span class="w">        </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">opcode_shift</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">address_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">data_shift</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_cnt_rx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_cnt_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">tx_reg</span><span class="w">        </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">wel</span><span class="w">           </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_miso</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_clk_prev</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">cs_prev</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">address</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="c1">// Merken des vorherigen SPI-Takt- und CS-Zustands</span>
<span class="w">      </span><span class="n">spi_clk_prev</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">spi_clk</span><span class="p">;</span>
<span class="w">      </span><span class="n">cs_prev</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">spi_cs</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Wenn spi_cs = 1, wird State-Logik zurückgesetzt</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_cs</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">state</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_OPCODE</span><span class="p">;</span>
<span class="w">        </span><span class="n">bit_cnt_rx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">bit_cnt_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">opcode_shift</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">address_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">data_shift</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">address</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="c1">// Wenn ein Write-Opcode beendet wird, wel=0</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP_WRITE</span><span class="p">)</span>
<span class="w">          </span><span class="n">wel</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="c1">// Flankenauswertung: steigende Flanke spi_clk</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_clk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">spi_clk_prev</span><span class="p">)</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>


<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="c1">// STATE_OPCODE: Zunächst 8 Bits für den OPCODE</span>
<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="nl">STATE_OPCODE:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">opcode_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">opcode_shift</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">};</span>
<span class="w">              </span><span class="n">bit_cnt_rx</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">opcode</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">opcode_shift</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">};</span>
<span class="w">                </span><span class="n">bit_cnt_rx</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">opcode_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">({</span><span class="n">opcode_shift</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">}</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP_WREN</span><span class="p">)</span>
<span class="w">                  </span><span class="n">wel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                  </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_ADDR</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="c1">// STATE_ADDR: 2 Bytes Adresse (16 Bit)</span>
<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="nl">STATE_ADDR:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">address_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">address_shift</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">};</span>
<span class="w">              </span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d15</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">tx_reg</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[{</span><span class="n">address_shift</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">}];</span>
<span class="w">                </span><span class="n">address</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">address_shift</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">};</span>
<span class="w">                </span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP_READ</span><span class="p">)</span>
<span class="w">                </span><span class="k">begin</span>
<span class="w">                  </span><span class="n">state</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_READ_DATA</span><span class="p">;</span>
<span class="w">                  </span><span class="n">bit_cnt_tx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                  </span><span class="n">spi_miso</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[{</span><span class="n">address_shift</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">}][</span><span class="mh">7</span><span class="p">];</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">OP_WRITE</span><span class="p">)</span>
<span class="w">                </span><span class="k">begin</span>
<span class="w">                  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wel</span><span class="p">)</span>
<span class="w">                    </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_WRITE_DATA</span><span class="p">;</span>
<span class="w">                  </span><span class="k">else</span>
<span class="w">                    </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_OPCODE</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                  </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_OPCODE</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="c1">// STATE_ADDR: 2 Bytes Adresse (16 Bit)</span>
<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="nl">STATE_WRITE_DATA:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">memory</span><span class="p">[(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">0</span><span class="p">])]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">data_shift</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">};</span>
<span class="w">                </span><span class="n">bit_cnt_rx</span><span class="w">              </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">data_shift</span><span class="w">              </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">address</span><span class="w">                 </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">data_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">data_shift</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="n">spi_mosi</span><span class="p">};</span>
<span class="w">                </span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_cnt_rx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="c1">// STATE_ADDR: 2 Bytes Adresse (16 Bit)</span>
<span class="w">            </span><span class="c1">// ---------------------------------------------</span>
<span class="w">            </span><span class="nl">STATE_READ_DATA:</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_cnt_tx</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">bit_cnt_tx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">                </span><span class="n">address</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">tx_reg</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[</span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">];</span>
<span class="w">                </span><span class="n">spi_miso</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">memory</span><span class="p">[(</span><span class="n">address</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">)][</span><span class="mh">7</span><span class="p">];</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">spi_miso</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_reg</span><span class="p">[</span><span class="mh">6</span><span class="p">];</span>
<span class="w">                </span><span class="n">tx_reg</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">tx_reg</span><span class="p">[</span><span class="mh">6</span><span class="o">:</span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">};</span>
<span class="w">                </span><span class="n">bit_cnt_tx</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_cnt_tx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>

<span class="w">            </span><span class="k">default</span><span class="o">:</span>
<span class="w">              </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_OPCODE</span><span class="p">;</span>

<span class="w">          </span><span class="k">endcase</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/memory.v</h2>
<h3 id="module-memory">Modul: memory</h3>
<p><strong>Kurzbeschreibung:</strong> Hauptspeichermodul mit Anbindung an Peripherie.</p>
<p>Dieses Modul verwaltet die Zugriffe der CPU auf den Speicher (RAM oder FRAM, je nach Definition <code>FRAM_MEMORY</code>) sowie auf die Peripherie. Dabei wird die Adresse aufgeteilt in einen RAM-Bereich und einen Peripheriebereich. Lese- und Schreibzugriffe im RAM-Bereich erfolgen direkt auf das RAM/FRAM; Zugriffe im Peripheriebereich werden an das <code>peripheral_bus</code> Modul weitergereicht.  Folgende Bereiche sind definiert: - Adressen &gt;= 0x00004000: RAM/FRAM-Bereich - Adressen &lt;  0x00004000: Peripherie-Bereich (per_addr)</p>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>        Systemtakt</li>
<li><code>rst_n</code>      Asynchron, aktives-LOW Reset</li>
<li><code>[31:0]</code>     address  Adresse des gewünschten Zugriffs</li>
<li><code>[31:0]</code>     write_data Daten, die bei we=1 geschrieben werden</li>
<li><code>we</code>         Write Enable</li>
<li><code>re</code>         Read Enable</li>
<li><code>uart_rx</code>    UART-Eingang</li>
<li><code>spi_miso</code>   SPI Master-In</li>
<li><code>[7:0]</code>      gpio_in   GPIO-Eingänge</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code>     read_data  Daten, die bei re=1 gelesen werden</li>
<li><code>mem_busy</code>   Signalisiert, ob ein externer Zugriff (z. B. FRAM) noch busy ist</li>
<li><code>uart_tx</code>    UART-Ausgang</li>
<li><code>[31:0]</code>     debug_out Debug-Leitung</li>
<li><code>pwm_out</code>    PWM-Ausgang</li>
<li><code>ws_out</code>     Datenleitung für WS2812B</li>
<li><code>spi_mosi</code>   SPI Master-Out</li>
<li><code>spi_clk</code>    SPI-Takt</li>
<li><code>spi_cs</code>     SPI-Chipselect</li>
<li><code>[7:0]</code>      gpio_out GPIO-Ausgänge</li>
<li><code>[7:0]</code>      gpio_dir GPIO-Richtungsregister</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;./defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">mem_busy</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_tx</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_rx</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">debug_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">pwm_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">ws_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_cs</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_dir</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_in</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Interne Signale für RAM/FRAM und Peripherie</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ram_addr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ram_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">13</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">per_addr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">per_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">is_ram</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">we_ram</span><span class="p">;</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">FRAM_MEMORY</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">re_ram</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">we_per</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">re_per</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">req_ready</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lese-/Schreib-Steuerung</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">we_ram</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  </span><span class="n">is_ram</span><span class="p">;</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">FRAM_MEMORY</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">re_ram</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w">  </span><span class="n">is_ram</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">we_per</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">is_ram</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">re_per</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">is_ram</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Aufteilung der Adressbereiche</span>
<span class="w">  </span><span class="c1">// is_ram = 1, wenn address &gt;= 0x00004000</span>
<span class="w">  </span><span class="c1">// Ansonsten per_addr = address[13:0]</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">is_ram</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">32&#39;h00004000</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">ram_addr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="mh">32&#39;h00004000</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">per_addr</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">is_ram</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">14</span><span class="mb">&#39;b0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">address</span><span class="p">[</span><span class="mh">13</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">is_ram</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ram_data</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">per_data</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// mem_busy wird aus req_ready abgeleitet</span>
<span class="w">  </span><span class="c1">// (Bei Normal-RAM meist nicht busy, bei FRAM schon)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">mem_busy</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">req_ready</span><span class="p">;</span>
<span class="no">`ifndef</span><span class="w"> </span><span class="n">FRAM_MEMORY</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">req_ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="no">`endif</span>

<span class="w">  </span><span class="c1">// -------------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// RAM bzw. FRAM-Anbindung</span>
<span class="w">  </span><span class="c1">// -------------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">FRAM_MEMORY</span>
<span class="w">  </span><span class="n">fram_ram</span><span class="w"> </span><span class="n">fram_ram_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">req_ready</span><span class="w">  </span><span class="p">(</span><span class="n">req_ready</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">ram_addr</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">ram_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">we_ram</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">re_ram</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_mosi</span><span class="w">   </span><span class="p">(</span><span class="n">spi_mosi</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_miso</span><span class="w">   </span><span class="p">(</span><span class="n">spi_miso</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_clk</span><span class="w">    </span><span class="p">(</span><span class="n">spi_clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_cs</span><span class="w">     </span><span class="p">(</span><span class="n">spi_cs</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
<span class="no">`else</span>
<span class="w">  </span><span class="c1">// Normales Single-Port-RAM</span>
<span class="w">  </span><span class="n">ram1p</span><span class="w"> </span><span class="n">ram1p_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="p">(</span><span class="n">ram_addr</span><span class="p">[</span><span class="mh">14</span><span class="o">:</span><span class="mh">2</span><span class="p">]),</span>
<span class="w">    </span><span class="p">.</span><span class="n">clock</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">data</span><span class="w">    </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wren</span><span class="w">    </span><span class="p">(</span><span class="n">we_ram</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">q</span><span class="w">       </span><span class="p">(</span><span class="n">ram_data</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
<span class="no">`endif</span>

<span class="w">  </span><span class="c1">// -------------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Anbindung der Peripheriemodule</span>
<span class="w">  </span><span class="c1">// -------------------------------------------------------------</span>
<span class="w">  </span><span class="n">peripheral_bus</span><span class="w"> </span><span class="n">peripheral_bus_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">per_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">per_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">we_per</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">re_per</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">debug_out</span><span class="w">  </span><span class="p">(</span><span class="n">debug_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">uart_tx</span><span class="w">    </span><span class="p">(</span><span class="n">uart_tx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">uart_rx</span><span class="w">    </span><span class="p">(</span><span class="n">uart_rx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">pwm_out</span><span class="w">    </span><span class="p">(</span><span class="n">pwm_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">ws_out</span><span class="w">     </span><span class="p">(</span><span class="n">ws_out</span><span class="p">),</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">FRAM_MEMORY</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_mosi</span><span class="w">   </span><span class="p">(),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_miso</span><span class="w">   </span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_clk</span><span class="w">    </span><span class="p">(),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_cs</span><span class="w">     </span><span class="p">(),</span>
<span class="no">`else</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_mosi</span><span class="w">   </span><span class="p">(</span><span class="n">spi_mosi</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_miso</span><span class="w">   </span><span class="p">(</span><span class="n">spi_miso</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_clk</span><span class="w">    </span><span class="p">(</span><span class="n">spi_clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_cs</span><span class="w">     </span><span class="p">(</span><span class="n">spi_cs</span><span class="p">),</span>
<span class="no">`endif</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_out</span><span class="w">   </span><span class="p">(</span><span class="n">gpio_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_dir</span><span class="w">   </span><span class="p">(</span><span class="n">gpio_dir</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_in</span><span class="w">    </span><span class="p">(</span><span class="n">gpio_in</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/debug_module.v</h2>
<h3 id="module-debug_module">Modul: debug_module</h3>
<p><strong>Kurzbeschreibung:</strong> Debug-Modul für Host-Kommunikation und Speicherzugriff</p>
<p>Dieses Modul stellt ein einfaches Register zur Verfügung, das über den Bus geschrieben und gelesen werden kann. Es wird außerdem über eine separate Leitung (debug_out) nach außen ausgegeben. Auf jeden Schreibzugriff hin wird der neue Wert im Simulator protokolliert.</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>DEBUG_ADDR</code> Basiskonstante zur Adresszuordnung</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>        Systemtakt</li>
<li><code>rst_n</code>      Reset-Signal</li>
<li><code>address</code>    Adresse, über die auf das Debug-Register zugegriffen wird</li>
<li><code>write_data</code> Zu schreibende Daten</li>
<li><code>we</code>         Write Enable-Signal</li>
<li><code>re</code>         Read Enable-Signal</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>read_data</code> Gelesene Daten aus dem Debug-Register</li>
<li><code>debug_out</code> Direkte Ausgabe des Debug-Registers (z. B. zu Diagnosezwecken)</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">debug_module</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">debug_out</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Basiskonstante für Debug-Adressen</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">DEBUG_ADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h00000000</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Internes Register, in dem Debug-Informationen abgelegt werden</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">debug_reg</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// Zuweisungen: Leseausgabe und Debug-Ausgang geben dasselbe Register aus</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debug_reg</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">debug_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">debug_reg</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Speichern oder Zurücksetzen des Debug-Registers</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">debug_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h00000000</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">debug_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">      </span><span class="c1">// Meldung im Simulator bei jedem Schreibzugriff</span>
<span class="w">      </span><span class="nb">$display</span><span class="p">(</span><span class="s">&quot;DEBUG_REG UPDATED: 0x%08X (%d) at time %0t&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span><span class="w"> </span><span class="nb">$time</span><span class="p">);</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/fifo.v</h2>
<h3 id="module-fifo">Modul: fifo</h3>
<p><strong>Kurzbeschreibung:</strong> Ein einfacher FIFO-Speicher.</p>
<p>Dieser FIFO (First-In-First-Out) Puffer speichert Daten mit einer konfigurierbaren Breite (<code>DATA_WIDTH</code>) und Tiefe (<code>DEPTH</code>). Daten werden über das <code>wr_en</code> Signal hineingeschrieben und über das <code>rd_en</code> Signal ausgelesen. Das Modul liefert die Signale <code>empty</code> und <code>full</code>, um anzuzeigen, ob weitere Lese- oder Schreibvorgänge möglich sind.</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>DATA_WIDTH</code> Breite der gespeicherten Daten in Bits.</li>
<li><code>DEPTH</code>      Anzahl der Einträge im FIFO.</li>
</ul>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>ADDR_WIDTH</code> Breite der Adresszeiger basierend auf <code>DEPTH</code>.</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>      Systemtakt.</li>
<li><code>rst_n</code>    Aktiv-low Reset.</li>
<li><code>wr_en</code>    Aktivierungssignal (Write-Enable) zum Schreiben in den FIFO.</li>
<li><code>rd_en</code>    Aktivierungssignal (Read-Enable) zum Lesen aus dem FIFO.</li>
<li><code>din</code>      Eingangsdaten mit Breite <code>DATA_WIDTH</code>.</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>empty</code>   Signal, das anzeigt, ob der FIFO leer ist.</li>
<li><code>full</code>    Signal, das anzeigt, ob der FIFO voll ist.</li>
<li><code>dout</code>    Ausgangsdaten mit Breite <code>DATA_WIDTH</code>.</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>


<span class="k">module</span><span class="w"> </span><span class="n">fifo</span><span class="w"> </span><span class="p">#(</span>
<span class="w">  </span><span class="k">parameter</span><span class="w"> </span><span class="n">DATA_WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8</span><span class="p">,</span>
<span class="w">  </span><span class="k">parameter</span><span class="w"> </span><span class="n">DEPTH</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">16</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">                  </span><span class="n">clk</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">                  </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">                  </span><span class="n">wr_en</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">                  </span><span class="n">rd_en</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">                  </span><span class="n">empty</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">                  </span><span class="n">full</span><span class="p">,</span>
<span class="w">    </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">din</span><span class="p">,</span>
<span class="w">    </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dout</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Abgeleitete Konstanten</span>
<span class="w">  </span><span class="c1">// ADDR_WIDTH entspricht der Logarithmusbasis 2 von DEPTH</span>
<span class="w">  </span><span class="c1">// und bestimmt die Größe der Lese-/Schreibzeiger</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">ADDR_WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$clog2</span><span class="p">(</span><span class="n">DEPTH</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// FIFO-internes Speicherarray, sowie Lese- und Schreibzeiger</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="w">  </span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">rd_ptr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="w">  </span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">wr_ptr</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">DATA_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="n">DEPTH</span><span class="o">-</span><span class="mh">1</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// Edge-Detections für wr_en und rd_en</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">wr_en_prev</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rd_en_prev</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Vorschau auf nächsten Schreibpointer</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="nl">ADDR_WIDTH:</span><span class="w"> </span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">next_wr</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// empty und full Signale</span>
<span class="w">  </span><span class="c1">// - empty: wenn Lese- und Schreibzeiger identisch sind</span>
<span class="w">  </span><span class="c1">// - full : wenn beide Pointer in Bezug auf MSB unterschiedlich</span>
<span class="w">  </span><span class="c1">//   sind, aber in Bezug auf die unteren Bits identisch</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">empty</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rd_ptr</span><span class="w">  </span><span class="o">==</span><span class="w"> </span><span class="n">wr_ptr</span><span class="p">);</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">full</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wr_ptr</span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="p">]</span><span class="w">     </span><span class="o">!=</span><span class="w"> </span><span class="n">rd_ptr</span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                   </span><span class="p">(</span><span class="n">wr_ptr</span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rd_ptr</span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]);</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">next_wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">wr_ptr</span><span class="w">   </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lese-/Schreiblogik</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">wr_ptr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">rd_ptr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">wr_en_prev</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">rd_en_prev</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="c1">// Speichern der vorherigen Zustände von wr_en und rd_en</span>
<span class="w">      </span><span class="n">wr_en_prev</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">wr_en</span><span class="p">;</span>
<span class="w">      </span><span class="n">rd_en_prev</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rd_en</span><span class="p">;</span>

<span class="w">      </span><span class="c1">// Schreiben in den FIFO, wenn wr_en ansteigt und nicht full</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wr_en</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">wr_en_prev</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">full</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">mem</span><span class="p">[</span><span class="n">wr_ptr</span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">din</span><span class="p">;</span>
<span class="w">        </span><span class="n">wr_ptr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">next_wr</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="c1">// Lesen aus dem FIFO, wenn rd_en ansteigt und nicht empty</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rd_en</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">rd_en_prev</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">empty</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">rd_ptr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rd_ptr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Daten-Ausgabe</span>
<span class="w">  </span><span class="c1">// - Wenn FIFO leer, wird ein Nullwert ausgegeben</span>
<span class="w">  </span><span class="c1">// - Ansonsten wird das Element an der rd_ptr-Position ausgegeben</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">dout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="n">DATA_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">rd_ptr</span><span class="p">[</span><span class="n">ADDR_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]];</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/gpio.v</h2>
<h3 id="module-gpio">Modul: gpio</h3>
<p><strong>Kurzbeschreibung:</strong> GPIO Modul zur Steuerung allgemeiner I/O.</p>
<p>Dieses Modul implementiert einen einfachen GPIO-Controller. Es unterstützt das Auslesen von Eingangspins und das Schreiben auf Ausgangspins über definierte Adressen. Die Richtungssteuerung (gpio_dir) ist derzeit nicht implementiert.</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>GPIO_DIR_BASE</code>   Momentan Nicht benutzt (exemplarisch, nicht benutzt)</li>
<li><code>GPIO_IN_OFFSET</code>  Basisadresse (Offset) für das GPIO-Eingangsregister</li>
<li><code>GPIO_OUT_OFFSET</code> Basisadresse (Offset) für das GPIO-Ausgangsregister</li>
<li><code>GPIO_OUT_STEP</code>   Schrittweite (Abstand) zwischen einzelnen GPIO-Ausgangsregistern</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>         Systemtakt.</li>
<li><code>rst_n</code>       Aktiv-low Reset-Signal.</li>
<li><code>address</code>     Speicheradresse zur Auswahl der GPIO-Register.</li>
<li><code>write_data</code>  Daten, die in die angesprochenen GPIO-Register geschrieben werden.</li>
<li><code>we</code>          Schreibaktivierungssignal (Write-Enable).</li>
<li><code>re</code>          Leseaktivierungssignal (Read-Enable).</li>
<li><code>gpio_in</code>     Eingangssignale von den GPIO-Pins.</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>read_data</code>  Ausgangsdaten basierend auf dem angesprochenen GPIO-Register.</li>
<li><code>gpio_out</code>   Register zur Steuerung des Ausgangszustands der GPIO-Pins.</li>
<li><code>gpio_dir</code>   GPIO-Richtungsregister (nicht implementiert).</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>


<span class="k">module</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">gpio_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">gpio_dir</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">gpio_in</span>
<span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lokale Parameter für Adressbereiche</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">GPIO_DIR_BASE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">GPIO_IN_OFFSET</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">GPIO_OUT_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">GPIO_OUT_STEP</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// pin_index wird aus der Adresse abgeleitet, um festzustellen,</span>
<span class="w">  </span><span class="c1">// welches Bit im gpio_out-Register angesprochen wird.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pin_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">GPIO_OUT_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mh">2</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lesezugriffe:</span>
<span class="w">  </span><span class="c1">// - Wenn address == GPIO_IN_OFFSET, wird gpio_in zurückgegeben.</span>
<span class="w">  </span><span class="c1">// - Wenn address im Bereich der Ausgangsregister liegt,</span>
<span class="w">  </span><span class="c1">//   wird das entsprechende gpio_out-Bit zurückgegeben.</span>
<span class="w">  </span><span class="c1">// - Andernfalls 0.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GPIO_IN_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">gpio_in</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">GPIO_OUT_OFFSET</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_OUT_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mh">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">GPIO_OUT_STEP</span><span class="p">)))</span><span class="w"> </span>
<span class="w">                     </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">31</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">gpio_out</span><span class="p">[</span><span class="n">pin_index</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Schreiben der gpio_out-Bits:</span>
<span class="w">  </span><span class="c1">// - Beim Reset werden gpio_out und gpio_dir initialisiert.</span>
<span class="w">  </span><span class="c1">// - Nur wenn address im Bereich für Ausgangsregister liegt und we=1,</span>
<span class="w">  </span><span class="c1">//   wird genau ein Bit (write_data[0]) im gpio_out geschrieben.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">gpio_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">gpio_dir</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">GPIO_OUT_OFFSET</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">GPIO_OUT_OFFSET</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mh">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">GPIO_OUT_STEP</span><span class="p">)))</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">gpio_out</span><span class="p">[</span><span class="n">pin_index</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/peripheral_bus.v</h2>
<h3 id="module-peripheral_bus">Modul: peripheral_bus</h3>
<p><strong>Kurzbeschreibung:</strong> Zentrales Peripherie-Bus-Modul</p>
<p>Dieses Modul bündelt alle Zugriffe auf die verschiedenen Peripherie-Komponenten (z. B. Debug, UART, Timer, PWM, SPI, GPIO etc.) und leitet Lese-/Schreibanfragen anhand einer Adress-Dekodierung an die entsprechenden Module weiter. Je nach aktivem Define (z. B. <code>INCLUDE_DEBUG</code>) wird die jeweilige Peripherie eingebunden oder nicht. Die Schnittstellen zu den einzelnen Modulen sind bereits in diesem Modul angelegt (z. B. uart_tx, gpio_out, pwm_out, ...).</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>DEBUG_BASE</code>  Basis-Adressenbereich für das Debug-Modul</li>
<li><code>UART_BASE</code>   Basis-Adressenbereich für das UART-Modul</li>
<li><code>TIME_BASE</code>   Basis-Adressenbereich für den System-Timer</li>
<li><code>PWM_BASE</code>    Basis-Adressenbereich für das PWM-Modul</li>
<li><code>MULT_BASE</code>   Basis-Adressenbereich für das Multiplikatormodul</li>
<li><code>DIV_BASE</code>    Basis-Adressenbereich für das Divisionsmodul</li>
<li><code>SPI_BASE</code>    Basis-Adressenbereich für das SPI-Modul</li>
<li><code>GPIO_BASE</code>   Basis-Adressenbereich für das GPIO-Modul</li>
<li><code>WS_BASE</code>     Basis-Adressenbereich für das WS2812B-Modul</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>         Systemtakt</li>
<li><code>rst_n</code>       Asynchrones, aktives-LOW Reset-Signal</li>
<li><code>[13:0]</code>      address  Bus-Adresse, aus der das jeweilige Peripheriemodul dekodiert wird</li>
<li><code>[31:0]</code>      write_data Zu schreibende Daten in das ausgewählte Modul</li>
<li><code>we</code>          Write Enable-Signal</li>
<li><code>re</code>          Read Enable-Signal</li>
<li><code>uart_rx</code>    RX-Eingang des UART</li>
<li><code>spi_miso</code>   SPI-Eingangsdaten (Master In, Slave Out)</li>
<li><code>[7:0]</code>      gpio_in  Eingangsleitungen des GPIO-Moduls</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>reg</code> [31:0] read_data Gelesene Daten von den Peripheriemodulen</li>
<li><code>[31:0]</code>     debug_out Debug-Ausgangssignal (z. B. zur Diagnose)</li>
<li><code>uart_tx</code>    TX-Ausgang des UART</li>
<li><code>pwm_out</code>    PWM-Ausgangssignal</li>
<li><code>ws_out</code>     Datenleitung für WS2812B-LEDs</li>
<li><code>spi_mosi</code>   SPI-Ausgangsdaten (Master Out, Slave In)</li>
<li><code>spi_clk</code>    SPI-Taktsignal</li>
<li><code>spi_cs</code>     SPI-Chip-Select</li>
<li><code>[7:0]</code>      gpio_out Ausgangssignale des GPIO-Moduls</li>
<li><code>[7:0]</code>      gpio_dir Richtungsregister des GPIO-Moduls</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;../defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">peripheral_bus</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">13</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">debug_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_tx</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_rx</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">pwm_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">ws_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_cs</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_dir</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_in</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// Basis-Adressen für die einzelnen Peripherie-Komponenten</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">DEBUG_BASE</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h01</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">UART_BASE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h02</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TIME_BASE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h03</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">PWM_BASE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MULT_BASE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h05</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">DIV_BASE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h06</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">SPI_BASE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h07</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">GPIO_BASE</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">WS_BASE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">6&#39;h09</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Aus der 14-Bit-Adresse wird hier der 8-Bit-Funktionsanteil extrahiert</span>
<span class="w">  </span><span class="c1">// (lower 8 Bits), um innerhalb des Peripheriemoduls weiter zu dekodieren.</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">func_addr</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">func_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Debug-Modul (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_DEBUG</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">debug_data</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// Auswahl, ob Adresse in Bereich des Debug-Moduls fällt</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">debug_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">debug_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">debug_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">debug_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DEBUG_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">debug_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">debug_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">debug_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">debug_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">debug_module</span><span class="w"> </span><span class="n">debug_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">debug_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">debug_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">debug_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">debug_out</span><span class="w">  </span><span class="p">(</span><span class="n">debug_out</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span><span class="c1">// Falls nicht eingebunden, werden ungenutzte Signale auf konstante Werte gesetzt</span>
<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">debug_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">debug_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">        </span><span class="n">debug_out</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// UART-Modul (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_UART</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">uart_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">uart_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">uart_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">uart_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">uart_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">UART_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">uart_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">uart_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">uart_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">uart_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">uart</span><span class="w"> </span><span class="p">#(</span>
<span class="w">    </span><span class="p">.</span><span class="n">FIFO_TX_DEPTH</span><span class="p">(</span><span class="no">`UART_FIFO_TX_DEPTH</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">FIFO_RX_DEPTH</span><span class="p">(</span><span class="no">`UART_FIFO_RX_DEPTH</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">uart_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">uart_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">uart_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">uart_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">uart_tx</span><span class="w">    </span><span class="p">(</span><span class="n">uart_tx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">uart_rx</span><span class="w">    </span><span class="p">(</span><span class="n">uart_rx</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">uart_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">          </span><span class="n">uart_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">        </span><span class="n">uart_tx</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// System Timer (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_TIME</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">time_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">time_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">time_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">time_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">time_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TIME_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">time_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">time_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">time_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">time_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">system_timer</span><span class="w"> </span><span class="n">system_timer_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">time_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">time_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">time_re</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">time_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">time_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// PWM-Timer (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_PWM</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pwm_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">pwm_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">pwm_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">pwm_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">pwm_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PWM_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">pwm_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">pwm_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">pwm_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">pwm_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">pwm_timer</span><span class="w"> </span><span class="n">pwm_timer_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">pwm_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">pwm_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">pwm_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">pwm_out</span><span class="w">    </span><span class="p">(</span><span class="n">pwm_out</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pwm_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">pwm_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">      </span><span class="n">pwm_out</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Sequentieller Multiplikator (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_MULT</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mult_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">mult_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">mult_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">mult_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">mult_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MULT_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">mult_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mult_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">mult_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">mult_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">seq_multiplier</span><span class="w"> </span><span class="n">seq_multiplier_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">mult_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">mult_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">mult_re</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mult_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">mult_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Sequentieller Divider (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_DIV</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">div_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">div_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">div_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">div_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">div_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DIV_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">div_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">div_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">div_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">div_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">seq_divider</span><span class="w"> </span><span class="n">seq_divider_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">div_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">div_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">div_re</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">div_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">div_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// SPI-Modul (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_SPI</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">spi_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SPI_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">spi_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">spi_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">spi_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">spi_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">spi</span><span class="w"> </span><span class="p">#(</span>
<span class="w">    </span><span class="p">.</span><span class="n">FIFO_TX_DEPTH</span><span class="p">(</span><span class="no">`SPI_FIFO_TX_DEPTH</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">FIFO_RX_DEPTH</span><span class="p">(</span><span class="no">`SPI_FIFO_RX_DEPTH</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">spi_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">spi_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">spi_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">spi_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_clk</span><span class="w">    </span><span class="p">(</span><span class="n">spi_clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_mosi</span><span class="w">   </span><span class="p">(</span><span class="n">spi_mosi</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_miso</span><span class="w">   </span><span class="p">(</span><span class="n">spi_miso</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_cs</span><span class="w">     </span><span class="p">(</span><span class="n">spi_cs</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">      </span><span class="n">spi_mosi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">      </span><span class="n">spi_clk</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">      </span><span class="n">spi_cs</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// GPIO-Modul (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_GPIO</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">gpio_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">gpio_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">gpio_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">gpio_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GPIO_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">gpio_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">gpio_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">gpio_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">gpio_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">gpio</span><span class="w"> </span><span class="n">gpio_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">gpio_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">gpio_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">gpio_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_out</span><span class="w">   </span><span class="p">(</span><span class="n">gpio_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_dir</span><span class="w">   </span><span class="p">(</span><span class="n">gpio_dir</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_in</span><span class="w">    </span><span class="p">(</span><span class="n">gpio_in</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">gpio_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">         </span><span class="n">gpio_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">       </span><span class="n">gpio_out</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">       </span><span class="n">gpio_dir</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// WS2812B-LED-Modul (optional über DEFINE eingebunden)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_WS</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ws_data</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">ws_sel</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">ws_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">ws_re</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">ws_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">12</span><span class="o">:</span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WS_BASE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">ws_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ws_sel</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">ws_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ws_sel</span><span class="p">;</span>

<span class="w">  </span><span class="n">ws2812b</span><span class="w"> </span><span class="n">ws2812b_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">func_addr</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">ws_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">ws_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">ws_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">ws_out</span><span class="w">     </span><span class="p">(</span><span class="n">ws_out</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="no">`else</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ws_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">ws_sel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w">      </span><span class="n">ws_out</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="no">`endif</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lesezugriffe: Hier wird je nach ausgewähltem Modul das passende</span>
<span class="w">  </span><span class="c1">// &#39;read_data&#39; ausgegeben. Falls kein passendes Modul selektiert</span>
<span class="w">  </span><span class="c1">// ist, wird 0x0 zurückgegeben.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">      </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">re</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>

<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_DEBUG</span>
<span class="w">      </span><span class="k">if</span><span class="w">      </span><span class="p">(</span><span class="n">debug_sel</span><span class="p">)</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">debug_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_UART</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_sel</span><span class="p">)</span><span class="w">  </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">uart_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_TIME</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_sel</span><span class="p">)</span><span class="w">  </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">time_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_PWM</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pwm_sel</span><span class="p">)</span><span class="w">   </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pwm_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_MULT</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mult_sel</span><span class="p">)</span><span class="w">  </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mult_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_DIV</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">div_sel</span><span class="p">)</span><span class="w">   </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">div_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_SPI</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_sel</span><span class="p">)</span><span class="w">   </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">spi_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_GPIO</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gpio_sel</span><span class="p">)</span><span class="w">  </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">gpio_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">INCLUDE_WS</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ws_sel</span><span class="p">)</span><span class="w">    </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ws_data</span><span class="p">;</span>
<span class="no">`endif</span>

<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">read_data</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h0</span><span class="p">;</span>

<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/pwm_timer.v</h2>
<h3 id="module-pwm_timer">Modul: pwm_timer</h3>
<p><strong>Kurzbeschreibung:</strong> PWM-Timer zur Erzeugung eines Pulsweitenmodulationssignals</p>
<p>Dieses Modul generiert ein PWM-Signal (Pulsweitenmodulation) mit konfigurierbarer Periode und Pulsbreite. Es wird typischerweise zur Ansteuerung von Motoren, LEDs oder anderen zeitgesteuerten Peripherien eingesetzt. Der Zähler läuft periodisch hoch und vergleicht seinen Wert mit einem Pulsbreitenwert, um das Ausgangssignal zu setzen.  Über das Register-Interface lassen sich folgende Werte setzen/auslesen: - <code>PERIOD_ADDR</code>  : Maximale Zählerperiode (PWM-Zykluslänge). - <code>DUTY_ADDR</code>    : Vergleichswert für die Pulsbreite (PWM-Anteil). - <code>COUNTER_ADDR</code> : Zur Einsicht in den aktuellen Zählerstand (kann auch zurückgesetzt werden). - <code>CTRL_ADDR</code>    : Steuerungsregister (z. B. Aktivierung, Prescaler).</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>PERIOD_ADDR</code>  Offset-Adresse für die Perioden-Register.</li>
<li><code>DUTY_ADDR</code>    Offset-Adresse für das Duty-Cycle-Register.</li>
<li><code>COUNTER_ADDR</code> Offset-Adresse für den Zählerstand.</li>
<li><code>CTRL_ADDR</code>    Offset-Adresse für das Steuerregister.</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>    Systemtakt.</li>
<li><code>rst_n</code>  Asynchroner, aktiver-LOW Reset.</li>
<li><code>[7:0]</code>  address    Adressoffset zur Auswahl der Register.</li>
<li><code>[31:0]</code> write_data Zu schreibende Daten in das ausgewählte Register.</li>
<li><code>we</code>     Write-Enable-Signal.</li>
<li><code>re</code>     Read-Enable-Signal.</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> read_data Auszulesende Daten (abhängig von <code>address</code>).</li>
<li><code>reg</code>    pwm_out   Das generierte PWM-Ausgangssignal.</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">pwm_timer</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">pwm_out</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lokale Offset-Adressen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">PERIOD_ADDR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">DUTY_ADDR</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">COUNTER_ADDR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CTRL_ADDR</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Registervariablen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">period</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">duty</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ctrl</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">pre_count</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lese-Multiplexer: Gibt je nach address den entsprechenden</span>
<span class="w">  </span><span class="c1">// Registerwert heraus.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PERIOD_ADDR</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">period</span><span class="w">  </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DUTY_ADDR</span><span class="p">)</span><span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="n">duty</span><span class="w">    </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">COUNTER_ADDR</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CTRL_ADDR</span><span class="p">)</span><span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="n">ctrl</span><span class="w">    </span><span class="o">:</span>
<span class="w">                     </span><span class="mh">32&#39;h0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Schreib- und Zähllogik für period, duty, counter, ctrl</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">      </span><span class="n">period</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d1000</span><span class="p">;</span>
<span class="w">      </span><span class="n">duty</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d500</span><span class="p">;</span>
<span class="w">      </span><span class="n">counter</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ctrl</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32&#39;h00010000</span><span class="p">;</span>
<span class="w">      </span><span class="n">pre_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="c1">// Bei Write-Enable wird abhängig von der address</span>
<span class="w">        </span><span class="c1">// das jeweilige Register überschrieben oder zurückgesetzt.</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="w">          </span><span class="nl">PERIOD_ADDR:</span>
<span class="w">            </span><span class="n">period</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">          </span><span class="nl">DUTY_ADDR:</span>
<span class="w">            </span><span class="n">duty</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">          </span><span class="nl">COUNTER_ADDR:</span>
<span class="w">            </span><span class="n">counter</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="nl">CTRL_ADDR:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">ctrl</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">            </span><span class="n">pre_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">];</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">;</span>
<span class="w">        </span><span class="k">endcase</span>
<span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">else</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pre_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="c1">// pre_count wird herabgesetzt, wenn &gt; 0</span>
<span class="w">        </span><span class="n">pre_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">pre_count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="c1">// Wenn Vorzähler abgelaufen ist, wird counter inkrementiert</span>
<span class="w">        </span><span class="n">pre_count</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ctrl</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">16</span><span class="p">];</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">period</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// PWM-Ausgabe:</span>
<span class="w">  </span><span class="c1">// - Ist das Bit ctrl[0] gesetzt, wird PWM aktiviert.</span>
<span class="w">  </span><span class="c1">// - ctrl[1] kann (je nach Nutzung) z. B. eine Art Modus</span>
<span class="w">  </span><span class="c1">//   für ein symmetrisches PWM sein (hier nur beispielhaft).</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">      </span><span class="n">pwm_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mh">0</span><span class="p">])</span><span class="w"> </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mh">1</span><span class="p">])</span>
<span class="w">          </span><span class="n">pwm_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">period</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mh">1</span><span class="p">))</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">          </span><span class="n">pwm_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">duty</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">else</span>
<span class="w">        </span><span class="n">pwm_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/seq_divider.v</h2>
<h3 id="module-seq_divider">Modul: seq_divider</h3>
<p><strong>Kurzbeschreibung:</strong> Sequentieller Divider (Divisionseinheit).</p>
<p>Dieses Modul führt eine sequentielle Division zweier 32-Bit-Werte durch. Dabei wird fortlaufend ein Teil des Dividenden mit dem Divisor verglichen und angepasst. Das Modul ist über ein Register-Interface ansprechbar: - <code>INFO_OFFSET</code>: Enthält das <code>busy</code>-Bit (Division noch aktiv). - <code>END_OFFSET</code> : Speicherort für den Dividenden (Endwert). - <code>SOR_OFFSET</code> : Speicherort für den Divisor (Startet die Division). - <code>QUO_OFFSET</code> : Liefert das Ergebnis (Quotient). - <code>REM_OFFSET</code> : Liefert den Restwert (Remainder).</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>INFO_OFFSET</code> Offset für das Statusregister (busy).</li>
<li><code>END_OFFSET</code>  Offset für den Dividenden.</li>
<li><code>SOR_OFFSET</code>  Offset für den Divisor (startet Division).</li>
<li><code>QUO_OFFSET</code>  Offset für den Quotienten.</li>
<li><code>REM_OFFSET</code>  Offset für den Rest.</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt.</li>
<li><code>rst_n</code>             Aktiv-low Reset.</li>
<li><code>[7:0]</code> address     Adresse für den Registerzugriff.</li>
<li><code>[31:0]</code> write_data Daten, die z. B. Dividenden/Divisor setzen.</li>
<li><code>we</code>                Schreibaktivierungssignal (Write-Enable).</li>
<li><code>re</code>                Leseaktivierungssignal (Read-Enable).</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> read_data  Ausgabedaten basierend auf address.</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">seq_divider</span><span class="w"> </span><span class="p">(</span><span class="w"> </span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span>
<span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lokale Adress-Offsets für das Register-Interface</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">INFO_OFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">END_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">SOR_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">QUO_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">;</span><span class="w"> </span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">REM_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h10</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Register für Dividenden, Divisor, Quotient und Rest</span>
<span class="w">  </span><span class="c1">// dvdend_tmp dient als Arbeitsregister (64 Bit),</span>
<span class="w">  </span><span class="c1">// um den Dividenden hochzuschieben und den Rest auszuarbeiten.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dividend</span><span class="p">;</span><span class="w"> </span><span class="c1">// Gespeicherter Dividendenwert</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">divisor</span><span class="p">;</span><span class="w">  </span><span class="c1">// Gespeicherter Divisor</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">dvdend_tmp</span><span class="p">;</span><span class="w"> </span><span class="c1">// Temporäre 64-Bit-Repräsentation des Dividenden</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">quotient</span><span class="p">;</span><span class="w">  </span><span class="c1">// Quotient</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">remainder</span><span class="p">;</span><span class="w"> </span><span class="c1">// Rest</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_index</span><span class="p">;</span><span class="w"> </span><span class="c1">// Zähler für 32-Bit schrittweise Division</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">busy</span><span class="p">;</span><span class="w">  </span><span class="c1">// Signalisiert laufende Division</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lesezugriffe: abhängig vom Offset wird das passende</span>
<span class="w">  </span><span class="c1">// Register oder das busy-Bit zurückgegeben.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INFO_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">31</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">busy</span><span class="p">}</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">END_OFFSET</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w">  </span><span class="n">dividend</span><span class="w">     </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SOR_OFFSET</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w">  </span><span class="n">divisor</span><span class="w">      </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">QUO_OFFSET</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w">  </span><span class="n">quotient</span><span class="w">     </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">REM_OFFSET</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w">  </span><span class="n">remainder</span><span class="w">    </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Sequentieller Ablauf:</span>
<span class="w">  </span><span class="c1">// - Schreiben von dividend und divisor startet Berechnung.</span>
<span class="w">  </span><span class="c1">// - Der Divisor wird sukzessive vom oberen Teil des Dividenden</span>
<span class="w">  </span><span class="c1">//   subtrahiert (wenn möglich), das Ergebnis fließt in quotient.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">dividend</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">divisor</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">quotient</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">remainder</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">dvdend_tmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_index</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">busy</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="c1">// Verarbeiten von Write-Zugriffen</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

<span class="w">          </span><span class="nl">END_OFFSET:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="c1">// Setzt den Dividenden und initialisiert das Arbeitsregister</span>
<span class="w">            </span><span class="n">dividend</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">            </span><span class="n">dvdend_tmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">write_data</span><span class="p">};</span><span class="w"> </span>
<span class="w">            </span><span class="n">quotient</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">            </span><span class="n">remainder</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="nl">SOR_OFFSET:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="c1">// Setzt den Divisor und aktiviert die Division</span>
<span class="w">            </span><span class="n">divisor</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">            </span><span class="n">bit_index</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d31</span><span class="p">;</span>
<span class="w">            </span><span class="n">busy</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">        </span><span class="k">endcase</span>
<span class="w">      </span><span class="k">end</span>


<span class="w">      </span><span class="c1">// Division in kleinen Schritten, solange busy=1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="c1">// Jede Iteration: </span>
<span class="w">        </span><span class="c1">// 1) Schiebe das 64-Bit-Fenster nach links (dvdend_tmp &lt;&lt; 1),</span>
<span class="w">        </span><span class="c1">// 2) Schiebe quotient nach links, </span>
<span class="w">        </span><span class="c1">// 3) teste, ob Divisor subtrahierbar ist.</span>
<span class="w">        </span><span class="n">dvdend_tmp</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">dvdend_tmp</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">quotient</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">quotient</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// Prüfe den oberen 32-Bit-Teil gegen divisor</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dvdend_tmp</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">divisor</span><span class="p">)</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">dvdend_tmp</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">dvdend_tmp</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">divisor</span><span class="p">;</span>
<span class="w">          </span><span class="n">quotient</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// Sobald alle Bits bearbeitet sind, legen wir remainder fest.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">remainder</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">dvdend_tmp</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span>
<span class="w">          </span><span class="n">busy</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">bit_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/seq_multiplier.v</h2>
<h3 id="module-seq_multiplier">Modul: seq_multiplier</h3>
<p><strong>Kurzbeschreibung:</strong> Sequentieller Multiplikator.</p>
<p>Dieses Modul implementiert eine sequentielle Multiplikation zweier 32-Bit-Werte. Die Multiplikation erfolgt durch aufeinanderfolgende Additionen basierend auf den Bits des Multiplikators.  Das Modul ist speicherabbildbasiert und kann über Adressen gesteuert werden: - <code>MUL1_OFFSET</code>: Erster Multiplikand. - <code>MUL2_OFFSET</code>: Zweiter Multiplikator (startet die Berechnung). - <code>RESH_OFFSET</code>: Höhere 32 Bits des Ergebnisses. - <code>RESL_OFFSET</code>: Niedrigere 32 Bits des Ergebnisses. - <code>INFO_OFFSET</code>: Gibt an, ob die Berechnung noch läuft (<code>busy</code>).</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>INFO_OFFSET</code> Adresse für den Status (<code>busy</code>-Bit).</li>
<li><code>MUL1_OFFSET</code> Adresse für den ersten Multiplikanden.</li>
<li><code>MUL2_OFFSET</code> Adresse für den zweiten Multiplikator (startet Berechnung).</li>
<li><code>RESH_OFFSET</code> Adresse für die höheren 32 Bit des Ergebnisses.</li>
<li><code>RESL_OFFSET</code> Adresse für die niedrigeren 32 Bit des Ergebnisses.</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>         Systemtakt.</li>
<li><code>rst_n</code>       Aktiv-low Reset.</li>
<li><code>address</code>     Speicheradresse für den Zugriff auf Register.</li>
<li><code>write_data</code>  Daten, die in die ausgewählten Register geschrieben werden sollen.</li>
<li><code>we</code>          Schreibaktivierungssignal (Write-Enable).</li>
<li><code>re</code>          Leseaktivierungssignal (Read-Enable).</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>read_data</code>  Zu lesende Daten basierend auf der Adresse.</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>


<span class="k">module</span><span class="w"> </span><span class="n">seq_multiplier</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lokale Adress-Offsets für die Register</span>
<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">INFO_OFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MUL1_OFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MUL2_OFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RESH_OFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RESL_OFFSET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h10</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Register für Multiplikanden, Ergebnis und Steuerung</span>
<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">multiplicand</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">multiplier</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">product</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_index</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="n">busy</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Leseausgabe: Je nach Adress-Offset wird entsprechender</span>
<span class="w">  </span><span class="c1">// Registerinhalt oder Status zurückgegeben.</span>
<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">INFO_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">31</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">busy</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MUL1_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">multiplicand</span><span class="w">  </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MUL2_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">multiplier</span><span class="w">    </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RESH_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">product</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RESL_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">product</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]</span><span class="o">:</span>
<span class="w">                     </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Sequentielle Abarbeitung der Multiplikation</span>
<span class="w">  </span><span class="c1">// -------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">      </span><span class="c1">// Initialisierung bei Reset</span>
<span class="w">      </span><span class="n">multiplicand</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">multiplier</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">product</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_index</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">busy</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="c1">// Behandlung von Bus-Schreibzugriffen</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="w">          </span><span class="nl">MUL1_OFFSET:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="c1">// Schreiben des ersten Multiplikanden</span>
<span class="w">            </span><span class="n">multiplicand</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="nl">MUL2_OFFSET:</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="c1">// Schreiben des zweiten Multiplikators -&gt; Start der Multiplikation</span>
<span class="w">            </span><span class="n">multiplier</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">            </span><span class="n">product</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">            </span><span class="n">bit_index</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">6</span><span class="mi">&#39;d31</span><span class="p">;</span>
<span class="w">            </span><span class="n">busy</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">endcase</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">      </span><span class="c1">// Wenn busy = 1, läuft die sequentielle Multiplikation</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">busy</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">multiplier</span><span class="p">[</span><span class="n">bit_index</span><span class="p">])</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">product</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="mh">64</span><span class="mi">&#39;d1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">bit_index</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">multiplicand</span><span class="p">);</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="c1">// Bitzähler reduzieren</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="c1">// Sobald alle Bits durch sind, ist die Multiplikation abgeschlossen</span>
<span class="w">          </span><span class="n">busy</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">bit_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/spi.v</h2>
<h3 id="module-spi">Modul: spi</h3>
<p><strong>Kurzbeschreibung:</strong> SPI-Peripheriemodul mit internen FIFO-Puffern.</p>
<p>Dieses Modul stellt ein SPI-Master-Interface bereit (MOSI/MISO/CLK/CS), mit jeweils einem TX- und RX-FIFO zur gepufferten Übertragung von Datenpaketen. Die Baudrate wird über ein konfigurierbares Clock-Divider- Register gesteuert. Zusätzlich kann zwischen automatischer und manueller Steuerung des CS-Signals gewählt werden.  Register-Offsets innerhalb des Moduls: - <code>CTRL_OFFSET</code>   : Steuerregister (Aktivierung, CS-Gen, etc.) - <code>CLK_OFFSET</code>    : Clock-Divider-Register (zur SPI-Takterzeugung) - <code>STATUS_OFFSET</code> : Statusbits (z. B. Busy, FIFO-Zustände) - <code>TX_OFFSET</code>     : TX-FIFO-Schreibregister - <code>RX_OFFSET</code>     : RX-FIFO-Leseregister - <code>CS_OFFSET</code>     : Manuelle Chip-Select-Steuerung</p>
<p><strong>Parameter:</strong></p>
<ul>
<li><code>FIFO_TX_DEPTH</code> = 8 Anzahl der Einträge im FIFO für TX</li>
<li><code>FIFO_RX_DEPTH</code> = 8 Anzahl der Einträge im FIFO für RX</li>
</ul>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>CTRL_OFFSET</code>   Offset für das Steuerregister</li>
<li><code>CLK_OFFSET</code>    Offset für den Baudratenteiler</li>
<li><code>STATUS_OFFSET</code> Offset für das Statusregister</li>
<li><code>TX_OFFSET</code>     Offset zum Schreiben in den TX-FIFO</li>
<li><code>RX_OFFSET</code>     Offset zum Lesen aus dem RX-FIFO</li>
<li><code>CS_OFFSET</code>     Offset für manuelle Chip-Select-Steuerung</li>
<li><code>STATE_IDLE</code>      Leerlaufzustand</li>
<li><code>STATE_LOAD</code>      Daten werden aus dem TX-FIFO übernommen</li>
<li><code>STATE_LOAD_WAIT</code> Wartezyklus nach dem Laden</li>
<li><code>STATE_TRANSFER</code>  Aktive SPI-Datenübertragung</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt</li>
<li><code>rst_n</code>             Asynchroner, aktiver-LOW Reset</li>
<li><code>[7:0]</code> address     Auswahl des Registers innerhalb des SPI-Moduls</li>
<li><code>[31:0]</code> write_data Daten, die in ein ausgewähltes Register geschrieben werden</li>
<li><code>we</code>                Write-Enable-Signal</li>
<li><code>re</code>                Read-Enable-Signal</li>
<li><code>wire</code>              spi_miso  SPI-Daten-Eingang  (Master In, Slave Out)</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> read_data  Ausgelesener Wert aus dem entsprechenden Register</li>
<li><code>reg</code>               spi_clk   SPI-Clock-Ausgang</li>
<li><code>reg</code>               spi_mosi  SPI-Daten-Ausgang (Master Out, Slave In)</li>
<li><code>wire</code>              spi_cs    SPI-Chip-Select (automatisch oder manuell)</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">spi</span><span class="w"> </span><span class="p">#(</span>
<span class="w">  </span><span class="k">parameter</span><span class="w"> </span><span class="n">FIFO_TX_DEPTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8</span><span class="p">,</span>
<span class="w">  </span><span class="k">parameter</span><span class="w"> </span><span class="n">FIFO_RX_DEPTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">8</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_cs</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Register-Offsets innerhalb des Adressraums</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CTRL_OFFSET</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CLK_OFFSET</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATUS_OFFSET</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TX_OFFSET</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RX_OFFSET</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h10</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CS_OFFSET</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h14</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustände des internen State-Automaten</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_IDLE</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_LOAD</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_LOAD_WAIT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_TRANSFER</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Registervariablen und -signale</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_clk_div</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">new_spi_clk_div</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">16</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">clk_counter</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_shift</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_fifo_din</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_cnt</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">spi_ctrl</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">tx_fifo_rd_en</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rx_fifo_wr_en</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rx_fifo_rd_en</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">read_flag</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">spi_clk_en</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">active</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">cs_gen</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">cs_manual</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">cs_manual_next</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// FIFOs für TX und RX</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_fifo_din</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_fifo_dout</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">status_bits</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">clk_div_zero</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_busy</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">spi_ready</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">tx_fifo_wr_en</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">tx_fifo_empty</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">tx_fifo_full</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rx_fifo_empty</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rx_fifo_full</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">fifo_full</span><span class="p">;</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Externe Zuweisungen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">clk_div_zero</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">~|</span><span class="n">spi_clk_div</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">spi_busy</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">STATE_IDLE</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">fifo_full</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">rx_fifo_full</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tx_fifo_full</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">spi_ready</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">spi_busy</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">tx_fifo_empty</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">rx_fifo_empty</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">status_bits</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">clk_div_zero</span><span class="p">,</span><span class="w"> </span><span class="n">fifo_full</span><span class="p">,</span><span class="w"> </span><span class="n">spi_ready</span><span class="p">,</span><span class="w"> </span><span class="n">spi_busy</span><span class="p">,</span><span class="w"> </span><span class="n">rx_fifo_full</span><span class="p">,</span><span class="w"> </span><span class="n">rx_fifo_empty</span><span class="p">,</span><span class="w"> </span><span class="n">tx_fifo_full</span><span class="p">,</span><span class="w"> </span><span class="n">tx_fifo_empty</span><span class="p">};</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">tx_fifo_din</span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">8</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">tx_fifo_wr_en</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TX_OFFSET</span><span class="p">);</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">spi_cs</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="n">cs_gen</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">cs_manual</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// TX-FIFO Instanz</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">fifo</span><span class="w"> </span><span class="p">#(</span>
<span class="w">    </span><span class="p">.</span><span class="n">DATA_WIDTH</span><span class="w"> </span><span class="p">(</span><span class="mh">9</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">DEPTH</span><span class="w">      </span><span class="p">(</span><span class="n">FIFO_TX_DEPTH</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">spi_tx_fifo</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w"> </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wr_en</span><span class="w"> </span><span class="p">(</span><span class="n">tx_fifo_wr_en</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rd_en</span><span class="w"> </span><span class="p">(</span><span class="n">tx_fifo_rd_en</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="w">   </span><span class="p">(</span><span class="n">tx_fifo_din</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="w">  </span><span class="p">(</span><span class="n">tx_fifo_dout</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">empty</span><span class="w"> </span><span class="p">(</span><span class="n">tx_fifo_empty</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">full</span><span class="w">  </span><span class="p">(</span><span class="n">tx_fifo_full</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// RX-FIFO Instanz</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">fifo</span><span class="w"> </span><span class="p">#(</span>
<span class="w">    </span><span class="p">.</span><span class="n">DATA_WIDTH</span><span class="w"> </span><span class="p">(</span><span class="mh">8</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">DEPTH</span><span class="w">      </span><span class="p">(</span><span class="n">FIFO_RX_DEPTH</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">spi_rx_fifo</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w"> </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wr_en</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fifo_wr_en</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rd_en</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fifo_rd_en</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="w">   </span><span class="p">(</span><span class="n">rx_fifo_din</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="w">  </span><span class="p">(</span><span class="n">rx_fifo_dout</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">empty</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fifo_empty</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">full</span><span class="w">  </span><span class="p">(</span><span class="n">rx_fifo_full</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lesen aus SPI-Registern (CTRL, CLK, STATUS, RX, CS)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CTRL_OFFSET</span><span class="p">)</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">30</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">cs_gen</span><span class="p">,</span><span class="w"> </span><span class="n">active</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CLK_OFFSET</span><span class="p">)</span><span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w">    </span><span class="n">spi_clk_div</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STATUS_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w">    </span><span class="n">status_bits</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RX_OFFSET</span><span class="p">)</span><span class="w">     </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">24</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w">   </span><span class="n">rx_fifo_dout</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CS_OFFSET</span><span class="p">)</span><span class="w">     </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">31</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w">      </span><span class="n">cs_manual</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Clock-Divider-Logik: Erzeugung von spi_clk</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">clk_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STATE_LOAD</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">clk_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clk_counter</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="p">{</span><span class="n">spi_clk_div</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">],</span><span class="w"> </span><span class="o">~|</span><span class="n">spi_clk_div</span><span class="p">})</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">clk_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>

<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">clk_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">clk_counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">16</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">        </span><span class="n">spi_clk_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>

<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustandsmaschine für SPI</span>
<span class="w">  </span><span class="c1">// - Übergänge zwischen Ladephase, Übertragung etc.</span>
<span class="w">  </span><span class="c1">// - Steuert spi_clk, mosi, bit_cnt, etc.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_IDLE</span><span class="p">;</span>
<span class="w">      </span><span class="n">cs</span><span class="w">            </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">cs_manual</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_clk</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_cnt</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">tx_shift</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_shift</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">read_flag</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">tx_fifo_rd_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_fifo_wr_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_mosi</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="c1">// Standard: Deaktivierung von FIFO-Lese/Schreib-Enables</span>
<span class="w">      </span><span class="n">tx_fifo_rd_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_fifo_wr_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="nl">STATE_IDLE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">cs_manual</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">cs_manual_next</span><span class="p">;</span>
<span class="w">          </span><span class="n">cs</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_clk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">bit_cnt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">active</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">tx_fifo_empty</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">cs</span><span class="w">            </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">tx_shift</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">tx_fifo_rd_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">STATE_LOAD:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">tx_fifo_rd_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="n">state</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD_WAIT</span><span class="p">;</span>
<span class="w">          </span><span class="n">cs</span><span class="w">            </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">STATE_LOAD_WAIT:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">tx_shift</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">          </span><span class="n">read_flag</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">[</span><span class="mh">8</span><span class="p">];</span>
<span class="w">          </span><span class="n">tx_fifo_rd_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">rx_shift</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">          </span><span class="n">bit_cnt</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_clk</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="n">spi_mosi</span><span class="w">      </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">[</span><span class="mh">7</span><span class="p">];</span>
<span class="w">          </span><span class="n">state</span><span class="w">         </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_TRANSFER</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">STATE_TRANSFER:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_clk_en</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_clk</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">spi_clk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_cnt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d7</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">rx_shift</span><span class="p">[</span><span class="mh">3</span><span class="mi">&#39;d7</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bit_cnt</span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">spi_miso</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">spi_clk</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_cnt</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d7</span><span class="p">)</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="n">bit_cnt</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_cnt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                </span><span class="n">spi_mosi</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">[</span><span class="mh">3</span><span class="mi">&#39;d6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bit_cnt</span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]];</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">              </span><span class="k">begin</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_flag</span><span class="p">)</span>
<span class="w">                </span><span class="k">begin</span>
<span class="w">                  </span><span class="n">rx_fifo_din</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_shift</span><span class="p">;</span>
<span class="w">                  </span><span class="n">rx_fifo_wr_en</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tx_fifo_empty</span><span class="p">)</span>
<span class="w">                </span><span class="k">begin</span>
<span class="w">                  </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD</span><span class="p">;</span>
<span class="w">                  </span><span class="c1">//tx_fifo_rd_en &lt;= 1&#39;b1;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                </span><span class="k">begin</span>
<span class="w">                  </span><span class="n">cs</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">                  </span><span class="n">state</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_IDLE</span><span class="p">;</span>
<span class="w">                </span><span class="k">end</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_TRANSFER</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">          </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_IDLE</span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Kontrolle der SPI-Einstellungen (CTRL, CLK, CS)</span>
<span class="w">  </span><span class="c1">// - Hier wird z. B. active und cs_gen gesetzt, sowie</span>
<span class="w">  </span><span class="c1">//   der Taktteiler aktualisiert</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">active</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">cs_manual_next</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">cs_gen</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">spi_clk_div</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">new_spi_clk_div</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">])</span>

<span class="w">        </span><span class="nl">CTRL_OFFSET:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">active</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">          </span><span class="n">cs_gen</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">CLK_OFFSET:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">new_spi_clk_div</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">CS_OFFSET:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">cs_manual_next</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="o">~</span><span class="n">write_data</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>

<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">spi_ready</span><span class="p">)</span>
<span class="w">      </span><span class="n">spi_clk_div</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">new_spi_clk_div</span><span class="p">;</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/system_timer.v</h2>
<h3 id="module-system_timer">Modul: system_timer</h3>
<p><strong>Kurzbeschreibung:</strong> System Timer</p>
<p>Dieses Modul stellt einen System-Timer bereit, der sowohl Millisekunden- als auch Mikrosekunden-Zähler verwaltet. Zwei Zähler (ms_counter, mik_counter) laufen in Abhängigkeit von <code>CLK_FREQ</code>, wodurch sich systemweite Zeitstempel erzeugen lassen. Über Register kann der Zählerinhalt ausgelesen oder zurückgesetzt werden.  Register-Offsets: - <code>MS_L_OFFSET</code>  : Niedrigere 32 Bit des Millisekunden-Zählers - <code>MS_H_OFFSET</code>  : Höhere 32 Bit des Millisekunden-Zählers - <code>MIK_L_OFFSET</code> : Niedrigere 32 Bit des Mikrosekunden-Zählers - <code>MIK_H_OFFSET</code> : Höhere 32 Bit des Mikrosekunden-Zählers - <code>SYS_CLOCK</code>    : Liefert die aktuelle Taktrate in Hz (niedrigere 32 Bit)</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>MS_COUNT_LIMIT</code>    Obergrenze für 1 ms (basierend auf <code>CLK_FREQ</code>)</li>
<li><code>MIK_COUNT_LIMIT</code>   Obergrenze für 1 µs (basierend auf <code>CLK_FREQ</code>)</li>
<li><code>MS_COUNTER_WIDTH</code>  Breite des Zählers für ms_counter</li>
<li><code>MIK_COUNTER_WIDTH</code> Breite des Zählers für mik_counter</li>
<li><code>MS_L_OFFSET</code>   Registeroffset für Millisekunden (Low)</li>
<li><code>MS_H_OFFSET</code>   Registeroffset für Millisekunden (High)</li>
<li><code>MIK_L_OFFSET</code>  Registeroffset für Mikrosekunden (Low)</li>
<li><code>MIK_H_OFFSET</code>  Registeroffset für Mikrosekunden (High)</li>
<li><code>SYS_CLOCK</code>     Registeroffset für das Auslesen der Taktfrequenz</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt.</li>
<li><code>rst_n</code>             Asynchroner, aktiver-LOW Reset.</li>
<li><code>[7:0]</code> address     Busadresse für das Lesen/Schreiben der Timerregister.</li>
<li><code>[31:0]</code> write_data Zu schreibende Daten (z. B. zum Zurücksetzen).</li>
<li><code>we</code>                Write-Enable.</li>
<li><code>re</code>                Read-Enable.</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> read_data  Enthält gelesene Daten abhängig von <code>address</code>.</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;../defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">system_timer</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span>
<span class="p">);</span>

<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MS_COUNT_LIMIT</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="no">`CLK_FREQ</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1000</span><span class="p">)</span><span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MIK_COUNT_LIMIT</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="no">`CLK_FREQ</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1000000</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">localparam</span><span class="w"> </span><span class="n">MS_COUNTER_WIDTH</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">$clog2</span><span class="p">(</span><span class="n">MS_COUNT_LIMIT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MIK_COUNTER_WIDTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">$clog2</span><span class="p">(</span><span class="n">MIK_COUNT_LIMIT</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">);</span>

<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MSW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MS_COUNTER_WIDTH</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MKW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MIK_COUNTER_WIDTH</span><span class="p">;</span>

<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MS_L_OFFSET</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MS_H_OFFSET</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MIK_L_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">MIK_H_OFFSET</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">SYS_CLOCK</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h10</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Timer-Register:</span>
<span class="w">  </span><span class="c1">// - ms_counter  + sys_tim_ms: für Millisekunden</span>
<span class="w">  </span><span class="c1">// - mik_counter + sys_tim_mik: für Mikrosekunden</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">MSW</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">ms_counter</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">MKW</span><span class="o">-</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mik_counter</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">63</span><span class="w">  </span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">sys_tim_ms</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">63</span><span class="w">  </span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">sys_tim_mik</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">sys_clk</span><span class="p">;</span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sys_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">`CLK_FREQ</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Leseauswahl je nach address:</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MS_L_OFFSET</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">sys_tim_ms</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MS_H_OFFSET</span><span class="p">)</span><span class="w">  </span><span class="o">?</span><span class="w"> </span><span class="n">sys_tim_ms</span><span class="w"> </span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MIK_L_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">sys_tim_mik</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MIK_H_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">sys_tim_mik</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SYS_CLOCK</span><span class="p">)</span><span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="n">sys_clk</span><span class="w">    </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="w"> </span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span>
<span class="w">                     </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Millisekunden-Zähler</span>
<span class="w">  </span><span class="c1">// - ms_counter zählt bis MS_COUNT_LIMIT</span>
<span class="w">  </span><span class="c1">// - Wird der Wert erreicht, dann sys_tim_ms++</span>
<span class="w">  </span><span class="c1">// - Auf Write an MS_L_OFFSET wird Timer zurückgesetzt</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">sys_tim_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ms_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">MSW</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MS_L_OFFSET</span><span class="p">))</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">sys_tim_ms</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">ms_counter</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">MSW</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ms_counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MS_COUNT_LIMIT</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">sys_tim_ms</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">sys_tim_ms</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">ms_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">MSW</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">ms_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ms_counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Mikrosekunden-Zähler</span>
<span class="w">  </span><span class="c1">// - mik_counter zählt bis MIK_COUNT_LIMIT</span>
<span class="w">  </span><span class="c1">// - Wird der Wert erreicht, dann sys_tim_mik++</span>
<span class="w">  </span><span class="c1">// - Auf Write an MIK_L_OFFSET wird Timer zurückgesetzt</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">sys_tim_mik</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">mik_counter</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">MKW</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MIK_L_OFFSET</span><span class="p">))</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">sys_tim_mik</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">64</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">        </span><span class="n">mik_counter</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">MKW</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mik_counter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">MIK_COUNT_LIMIT</span><span class="p">)</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">sys_tim_mik</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">sys_tim_mik</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">mik_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">MKW</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">      </span><span class="k">begin</span>
<span class="w">        </span><span class="n">mik_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mik_counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/uart.v</h2>
<h3 id="module-uart">Modul: uart</h3>
<p><strong>Kurzbeschreibung:</strong> UART-Modul mit TX-/RX-FIFOs</p>
<p>Dieses Modul implementiert eine einfache serielle Schnittstelle (UART). Es enthält interne FIFOs (TX und RX), die in ihrer Tiefe per Parameter festgelegt werden können. Die Baudrate kann über das Baudraten-Register gewählt werden, wobei mehrere vordefinierte Optionen existieren (z. B. 115200, 57600).  Register-Offsets innerhalb des UART-Moduls: - <code>CTRL_OFFSET</code>   : Steuerregister (z. B. Aktivierung). - <code>BAUD_OFFSET</code>   : Wahl der Baudraten-Voreinstellung (4-Bit: 0..11). - <code>STATUS_OFFSET</code> : Statusbits (z. B. FIFO-Zustand, Busy). - <code>TX_OFFSET</code>     : Schreiben in die TX-FIFO. - <code>RX_OFFSET</code>     : Lesen aus der RX-FIFO.</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>BAUD_DIV_115200</code> ... BAUD_DIV_300 : Vordefinierte Baudteiler abhängig von <code>CLK_FREQ</code>.</li>
<li><code>DIV_WIDTH</code>                        : Breite der Taktteilerzähler.</li>
<li><code>CTRL_OFFSET</code>                      : Offset für das Steuerregister.</li>
<li><code>BAUD_OFFSET</code>                      : Offset für das Baudratenregister.</li>
<li><code>STATUS_OFFSET</code>                    : Offset für Statusbits.</li>
<li><code>TX_OFFSET</code>                        : Offset zum Schreiben in die TX-FIFO.</li>
<li><code>RX_OFFSET</code>                        : Offset zum Lesen aus der RX-FIFO.</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt</li>
<li><code>rst_n</code>             Asynchrones, aktives-LOW Reset</li>
<li><code>[7:0]</code> address     Adressoffset zur Auswahl der Register</li>
<li><code>[31:0]</code> write_data Zu schreibende Daten in das jeweilige Register</li>
<li><code>we</code>                Write-Enable-Signal</li>
<li><code>re</code>                Read-Enable-Signal</li>
<li><code>uart_rx</code>   UART-Eingangssignal (RX)</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> read_data  Gelesener Wert aus dem entsprechenden Register</li>
<li><code>reg</code>     uart_tx   UART-Ausgangssignal (TX)</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;../defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">uart</span><span class="w"> </span><span class="p">#(</span>
<span class="w">  </span><span class="k">parameter</span><span class="w"> </span><span class="n">FIFO_TX_DEPTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">16</span><span class="p">,</span>
<span class="w">  </span><span class="k">parameter</span><span class="w"> </span><span class="n">FIFO_RX_DEPTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">16</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">         </span><span class="n">uart_tx</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_rx</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Vordefinierte Baudteiler für verschiedene Standardbaudraten</span>
<span class="w">  </span><span class="c1">// basierend auf dem Makro `CLK_FREQ` aus &quot;defines.v&quot;.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_115200</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">115200</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_57600</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">57600</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_38400</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">38400</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_28800</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">28800</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_23040</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">23040</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_19200</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">19200</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_14400</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">14400</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_9600</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">9600</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_4800</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">4800</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_2400</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">2400</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_1200</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">1200</span><span class="p">);</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_DIV_300</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="no">`BAUD_DIV</span><span class="p">(</span><span class="mh">300</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Breite der Teilerzähler</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">DIV_WIDTH</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">$clog2</span><span class="p">(</span><span class="n">BAUD_DIV_300</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Register-Offsets</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CTRL_OFFSET</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">BAUD_OFFSET</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATUS_OFFSET</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TX_OFFSET</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RX_OFFSET</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mh">8&#39;h10</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustände für RX/TX State Machines</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RX_IDLE</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RX_START</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RX_DATA</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">RX_STOP</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="p">;</span>

<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TX_IDLE</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TX_START</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TX_DATA</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">TX_STOP</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Bauddiv-Zähler, Shiftregister etc.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">DIV_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_bd_cntr</span><span class="p">;</span><span class="w"> </span><span class="c1">//Bauddiv-Zähler für TX</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">DIV_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_bd_cntr</span><span class="p">;</span><span class="w"> </span><span class="c1">//Bauddiv-Zähler für RX</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="n">DIV_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="p">;</span><span class="w"> </span><span class="c1">// Zwischenspeicher für akt. Baudratenteiler</span>

<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">;</span><span class="w">     </span><span class="c1">// 8-Bit Shiftregister zum Senden</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_shift</span><span class="p">;</span><span class="w">     </span><span class="c1">// 8-Bit Shiftregister zum Empfangen</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">baud_sel</span><span class="p">;</span><span class="w">     </span><span class="c1">// Auswahl der Baudrate (0..11)</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">new_baud_sel</span><span class="p">;</span><span class="w"> </span><span class="c1">// Puffer für Baudraten-Update</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_bit_id</span><span class="p">;</span><span class="w">    </span><span class="c1">// Zähler für TX-Bits</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_bit_id</span><span class="p">;</span><span class="w">    </span><span class="c1">// Zähler für RX-Bits</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_state</span><span class="p">;</span><span class="w">     </span><span class="c1">// State Machine: Senden</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_state</span><span class="p">;</span><span class="w">     </span><span class="c1">// State Machine: Empfangen</span>

<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rx_fifo_we</span><span class="p">;</span><span class="w">          </span><span class="c1">// Schreibeaktivierung RX-FIFO</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">tx_fifo_rd</span><span class="p">;</span><span class="w">          </span><span class="c1">// Leseaktivierung TX-FIFO</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rx_sync_1</span><span class="p">;</span><span class="w">           </span><span class="c1">// Doppelte Synchronisierung von uart_rx</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rx_sync_2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">rx_last</span><span class="p">;</span><span class="w">             </span><span class="c1">// Letzter Zustand vom synchronisieren RX</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">new_active</span><span class="p">;</span><span class="w">          </span><span class="c1">// Puffer für aktives UART</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="n">active</span><span class="p">;</span><span class="w">              </span><span class="c1">// UART aktiv?</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// FIFOs und Statusbits</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_fifo_dout</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">tx_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rx_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">status_bits</span><span class="p">;</span>

<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">tx_fifo_we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rx_fifo_re</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">tx_fifo_empty</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">tx_fifo_full</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rx_fifo_empty</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rx_fifo_full</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">rx_fall_edge</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">uart_busy</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="n">uart_ready</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Wahl des Baudteilers basierend auf baud_sel</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">baud_sel</span><span class="p">)</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_115200</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d1</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_57600</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d2</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_38400</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d3</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_28800</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d4</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_23040</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d5</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_19200</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d6</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_14400</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d7</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_9600</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d8</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_4800</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d9</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_2400</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d10</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_1200</span><span class="p">;</span>
<span class="w">      </span><span class="mh">4</span><span class="mi">&#39;d11</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_300</span><span class="p">;</span>
<span class="w">      </span><span class="k">default</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BAUD_DIV_115200</span><span class="p">;</span>
<span class="w">    </span><span class="k">endcase</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Aufsplitten von write_data in 8 Bit</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">tx_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="n">write_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rx_data</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rx_fifo_dout</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="w">  </span><span class="c1">// Wenn in TX_OFFSET geschrieben wird, soll in TX-FIFO geschreiben werden</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">tx_fifo_we</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">TX_OFFSET</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Wenn RX_OFFSET gelesen wird, soll aus RX-FIFO gelesen werden</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rx_fifo_re</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">re</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RX_OFFSET</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// UART-Busy, wenn TX oder RX gerade senden/empfangen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">uart_busy</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">tx_state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">TX_IDLE</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">rx_state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RX_IDLE</span><span class="p">));</span>
<span class="w">  </span><span class="c1">// UART_ready, wenn nicht busy und beide FIFOs leer</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">uart_ready</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="n">uart_busy</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">tx_fifo_empty</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">rx_fifo_empty</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Statusbits (bit 5:0)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// bit5 = tx_fifo_empty</span>
<span class="w">  </span><span class="c1">// bit4 = tx_fifo_full</span>
<span class="w">  </span><span class="c1">// bit3 = rx_fifo_empty</span>
<span class="w">  </span><span class="c1">// bit2 = rx_fifo_full</span>
<span class="w">  </span><span class="c1">// bit1 = uart_busy</span>
<span class="w">  </span><span class="c1">// bit0 = uart_ready</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">status_bits</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">uart_ready</span><span class="p">,</span><span class="w"> </span><span class="n">uart_busy</span><span class="p">,</span><span class="w"> </span><span class="n">rx_fifo_full</span><span class="p">,</span><span class="w"> </span><span class="n">rx_fifo_empty</span><span class="p">,</span><span class="w"> </span><span class="n">tx_fifo_full</span><span class="p">,</span><span class="w"> </span><span class="n">tx_fifo_empty</span><span class="p">};</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Erkennung fallende Flanke bei RX (Startbit-Erkennung)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rx_fall_edge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rx_last</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">rx_sync_2</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Leseauswahl für read_data</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CTRL_OFFSET</span><span class="p">)</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">31</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">active</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                        </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BAUD_OFFSET</span><span class="p">)</span><span class="w">   </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">28</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">baud_sel</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                        </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">STATUS_OFFSET</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">26</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">status_bits</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                        </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RX_OFFSET</span><span class="p">)</span><span class="w">     </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">23</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="o">!</span><span class="n">rx_fifo_empty</span><span class="p">,</span><span class="w"> </span><span class="n">rx_data</span><span class="p">}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                        </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// TX-FIFO (zur Pufferung ausgehender Daten)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">fifo</span><span class="w"> </span><span class="p">#(</span>
<span class="w">    </span><span class="p">.</span><span class="n">DATA_WIDTH</span><span class="w"> </span><span class="p">(</span><span class="mh">8</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">DEPTH</span><span class="w">      </span><span class="p">(</span><span class="n">FIFO_TX_DEPTH</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">tx_fifo_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w"> </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wr_en</span><span class="w"> </span><span class="p">(</span><span class="n">tx_fifo_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="w">   </span><span class="p">(</span><span class="n">tx_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rd_en</span><span class="w"> </span><span class="p">(</span><span class="n">tx_fifo_rd</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="w">  </span><span class="p">(</span><span class="n">tx_fifo_dout</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">empty</span><span class="w"> </span><span class="p">(</span><span class="n">tx_fifo_empty</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">full</span><span class="w">  </span><span class="p">(</span><span class="n">tx_fifo_full</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// RX-FIFO (zur Pufferung eingehender Daten)</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">fifo</span><span class="w"> </span><span class="p">#(</span>
<span class="w">    </span><span class="p">.</span><span class="n">DATA_WIDTH</span><span class="w"> </span><span class="p">(</span><span class="mh">8</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">DEPTH</span><span class="w">      </span><span class="p">(</span><span class="n">FIFO_RX_DEPTH</span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="n">rx_fifo_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">   </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w"> </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">wr_en</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fifo_we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">din</span><span class="w">   </span><span class="p">(</span><span class="n">rx_shift</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rd_en</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fifo_re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">dout</span><span class="w">  </span><span class="p">(</span><span class="n">rx_fifo_dout</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">empty</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fifo_empty</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">full</span><span class="w">  </span><span class="p">(</span><span class="n">rx_fifo_full</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// TX-State Machine:</span>
<span class="w">  </span><span class="c1">// TX_IDLE  -&gt; warten, bis Daten in TX-FIFO + active=1</span>
<span class="w">  </span><span class="c1">// TX_START -&gt; Latenz für Startbit</span>
<span class="w">  </span><span class="c1">// TX_DATA  -&gt; Sendet 8 Datenbits</span>
<span class="w">  </span><span class="c1">// TX_STOP  -&gt; Sendet Stopbit</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">tx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_IDLE</span><span class="p">;</span>
<span class="w">      </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">      </span><span class="n">tx_fifo_rd</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">uart_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">tx_shift</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">tx_bit_id</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">tx_state</span><span class="p">)</span>

<span class="w">        </span><span class="nl">TX_IDLE:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">tx_fifo_empty</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">active</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_shift</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_fifo_dout</span><span class="p">;</span>
<span class="w">            </span><span class="n">tx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_START</span><span class="p">;</span>
<span class="w">            </span><span class="n">tx_fifo_rd</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">TX_START:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">tx_fifo_rd</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">            </span><span class="n">tx_bit_id</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">            </span><span class="n">uart_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">tx_shift</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">1</span><span class="p">]};</span>
<span class="w">            </span><span class="n">tx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_DATA</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">{{(</span><span class="n">DIV_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}},</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">};</span>
<span class="w">            </span><span class="n">uart_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span><span class="w">        </span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">TX_DATA:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">            </span><span class="n">uart_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">            </span><span class="n">tx_shift</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">tx_shift</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">1</span><span class="p">]};</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_bit_id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">7</span><span class="p">)</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">tx_bit_id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_bit_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">              </span><span class="n">tx_state</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_DATA</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">              </span><span class="n">tx_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_STOP</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">{{(</span><span class="n">DIV_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}},</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">};</span>
<span class="w">            </span><span class="n">tx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_DATA</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">TX_STOP:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="p">)</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">            </span><span class="n">tx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_IDLE</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">tx_bd_cntr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">{{(</span><span class="n">DIV_WIDTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}},</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">};</span>
<span class="w">            </span><span class="n">uart_tx</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">tx_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">TX_IDLE</span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// RX-Synchronisation: Doppelte Abtastung von uart_rx</span>
<span class="w">  </span><span class="c1">// -&gt; rx_sync_1, rx_sync_2, rx_last zum Erkennen von Flanken</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">rx_sync_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_sync_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_last</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">rx_sync_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">uart_rx</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_sync_2</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_sync_1</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_last</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_sync_2</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// RX-State Machine: Empfangen eines Bytes</span>
<span class="w">  </span><span class="c1">// RX_IDLE  -&gt; Warten auf fallende Flanke (Startbit)</span>
<span class="w">  </span><span class="c1">// RX_START -&gt; Warte eine halbe Bitdauer</span>
<span class="w">  </span><span class="c1">// RX_DATA  -&gt; 8 Bits empfangen</span>
<span class="w">  </span><span class="c1">// RX_STOP  -&gt; Stopbit abwarten, ggf. in FIFO schreiben</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">rx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">RX_IDLE</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">      </span><span class="n">rx_bit_id</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">      </span><span class="n">rx_fifo_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">rx_fifo_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">rx_state</span><span class="p">)</span>

<span class="w">          </span><span class="nl">RX_IDLE:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_fall_edge</span><span class="p">)</span>
<span class="w">                </span><span class="n">rx_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">RX_START</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="nl">RX_START:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">bd_div_cnt</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mh">1</span><span class="p">))</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">              </span><span class="n">rx_bit_id</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="w">              </span><span class="n">rx_state</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">RX_DATA</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">              </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="nl">RX_DATA:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="p">)</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">rx_bd_cntr</span><span class="w">          </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>
<span class="w">              </span><span class="n">rx_shift</span><span class="p">[</span><span class="n">rx_bit_id</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">uart_rx</span><span class="p">;</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_bit_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">7</span><span class="p">)</span>
<span class="w">                </span><span class="n">rx_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">RX_STOP</span><span class="p">;</span>
<span class="w">              </span><span class="k">else</span>
<span class="w">                </span><span class="n">rx_bit_id</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_bit_id</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>

<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">              </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="nl">RX_STOP:</span>
<span class="w">          </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">bd_div_cnt</span><span class="p">)</span>
<span class="w">            </span><span class="k">begin</span>
<span class="w">              </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">DIV_WIDTH</span><span class="p">{</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">}};</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rx_fifo_full</span><span class="p">)</span>
<span class="w">                  </span><span class="n">rx_fifo_we</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>

<span class="w">              </span><span class="n">rx_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">RX_IDLE</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">              </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rx_bd_cntr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="k">default</span><span class="o">:</span>
<span class="w">            </span><span class="n">rx_state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">RX_IDLE</span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Steuerung von &quot;active&quot;, &quot;baud_sel&quot; (Register-Schreibzugriffe)</span>
<span class="w">  </span><span class="c1">// Erst wenn das UART idle und die FIFOs leer sind (uart_ready),</span>
<span class="w">  </span><span class="c1">// wird baud_sel und active aktualisiert.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">active</span><span class="w">       </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">new_active</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="w">      </span><span class="n">baud_sel</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">new_baud_sel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>

<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">])</span>

<span class="w">        </span><span class="nl">CTRL_OFFSET:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">new_active</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">BAUD_OFFSET:</span>
<span class="w">          </span><span class="n">new_baud_sel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">uart_ready</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">baud_sel</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">new_baud_sel</span><span class="p">;</span>
<span class="w">      </span><span class="n">active</span><span class="w">   </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">new_active</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/peripherals/ws2812b.v</h2>
<h3 id="module-ws2812b">Modul: ws2812b</h3>
<p><strong>Kurzbeschreibung:</strong> Treibermodul für WS2812B-LEDs (NeoPixel).</p>
<p>Dieses Modul steuert eine Kette von WS2812B-LEDs. Es werden nacheinander 24-Bit-Farbwerte (GRB) an die LEDs gesendet. Die Zeitsteuerung erfolgt über entsprechende Zähler (T0H, T0L, T1H, T1L, T_RESET). Dieses Beispiel zeigt eine einfache State-Maschine, die die Daten nacheinander an jede LED überträgt, dann ein Reset-Puls erzeugt und wieder von vorne beginnt.  Register-Offsets (jeweils 8 Bit auseinanderliegend): - 0x00: Daten für LED 0 - 0x04: Daten für LED 1 - 0x08: Daten für LED 2 - 0x0C: Daten für LED 3 - 0x10: Daten für LED 4 - 0x14: Daten für LED 5 - 0x18: Daten für LED 6 - 0x1C: Daten für LED 7</p>
<p><strong>Lokale Parameter:</strong></p>
<ul>
<li><code>CLK_PERIOD_NS</code> Zeit pro Takt in Nanosekunden, abgeleitet aus <code>CLK_FREQ</code>.</li>
<li><code>T0H</code>           Länger des "High" bei Bit=0</li>
<li><code>T0L</code>           Länger des "Low" bei Bit=0</li>
<li><code>T1H</code>           Länger des "High" bei Bit=1</li>
<li><code>T1L</code>           Länger des "Low" bei Bit=1</li>
<li><code>T_RESET</code>       Pause, damit die LED-Kette den Frame erkennt</li>
<li><code>STATE_LOAD_LED</code>  Initialer Zustand zum Laden der LED-Daten</li>
<li><code>STATE_SEND_HIGH</code> Sendephase: Leitung auf High</li>
<li><code>STATE_SEND_LOW</code>  Sendephase: Leitung auf Low</li>
<li><code>STATE_RESET</code>     Reset-Pause nach allen Bits</li>
</ul>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>               Systemtakt</li>
<li><code>rst_n</code>             Asynchroner, aktiver-LOW Reset</li>
<li><code>[7:0]</code>  address    Adressoffset, um eine der 8 LED-Daten zu wählen</li>
<li><code>[31:0]</code> write_data Zu schreibender RGB-Wert (24 Bit genutzt)</li>
<li><code>we</code>                Write Enable zum Setzen von LED-Farbwerten</li>
<li><code>re</code>                Read Enable zum Auslesen gespeicherter Werte</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> read_data  Gibt den gespeicherten RGB-Wert zurück</li>
<li><code>reg</code>  ws_out       Ausgangssignal zur WS2812B-Datenleitung</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;../defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">ws2812b</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">         </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">         </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">  </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">         </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">         </span><span class="n">re</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">          </span><span class="n">ws_out</span>
<span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Ermitteln der Taktperiode in Nanosekunden basierend auf CLK_FREQ.</span>
<span class="w">  </span><span class="c1">// Werte T0H, T0L, T1H, T1L, T_RESET werden gerundet (IntegerDivision).</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="n">_000_000_000</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="no">`CLK_FREQ</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">T0H</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mh">400</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">T0L</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mh">850</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">T1H</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mh">800</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">T1L</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mh">450</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">T_RESET</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mh">50</span><span class="n">_000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">CLK_PERIOD_NS</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Zustandsdefinitionen</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_LOAD_LED</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_SEND_HIGH</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d1</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_SEND_LOW</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d2</span><span class="p">;</span>
<span class="w">  </span><span class="k">localparam</span><span class="w"> </span><span class="n">STATE_RESET</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mh">2</span><span class="mi">&#39;d3</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// LED-Daten: 8 LEDs à 24 Bit RGB</span>
<span class="w">  </span><span class="c1">// - led_rgb[i] ist ein 24-Bit-Wert, repräsentiert G,R,B</span>
<span class="w">  </span><span class="c1">// - Schieberegister shift_reg zum Senden</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">led_rgb</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">7</span><span class="p">];</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">timer</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">bit_index</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">led_index</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lese-Multiplexer: Bei Adressen 0x00, 0x04, 0x08, ... 0x1C</span>
<span class="w">  </span><span class="c1">// wird der entsprechende led_rgb[i]-Wert (24 Bit) zurückgegeben.</span>
<span class="w">  </span><span class="c1">// Die oberen 8 Bit von read_data bleiben 0.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">read_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h00</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">0</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h04</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">1</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h08</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">2</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h0C</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">3</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h10</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">4</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h14</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">5</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h18</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">6</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">8&#39;h1C</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="mh">8</span><span class="mb">&#39;b0</span><span class="p">,</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">7</span><span class="p">]}</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Schreiben in die LED-Register</span>
<span class="w">  </span><span class="c1">// - address = 0x00, 0x04, ... =&gt; speichert 24 Bit in led_rgb</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">24&#39;h0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="w">        </span><span class="mh">8&#39;h00</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h04</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h08</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h0C</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h10</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h14</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h18</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="mh">8&#39;h1C</span><span class="o">:</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="mh">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">write_data</span><span class="p">[</span><span class="mh">23</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="p">;</span>
<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Haupt-Zustandsmaschine:</span>
<span class="w">  </span><span class="c1">// 1) STATE_LOAD_LED: Lade Daten der aktuellen LED in shift_reg.</span>
<span class="w">  </span><span class="c1">// 2) STATE_SEND_HIGH: Sende &quot;High&quot;-Phase (T0H oder T1H).</span>
<span class="w">  </span><span class="c1">// 3) STATE_SEND_LOW:  Sende &quot;Low&quot;-Phase  (T0L oder T1L).</span>
<span class="w">  </span><span class="c1">// 4) STATE_RESET:     Nach allen Bits die Resetlücke (T_RESET).</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">state</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD_LED</span><span class="p">;</span>
<span class="w">      </span><span class="n">led_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">bit_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d23</span><span class="p">;</span>
<span class="w">      </span><span class="n">timer</span><span class="w">     </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">ws_out</span><span class="w">    </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">      </span><span class="n">shift_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="w">        </span><span class="nl">STATE_LOAD_LED:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="n">shift_reg</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">{</span><span class="n">led_rgb</span><span class="p">[</span><span class="n">led_index</span><span class="p">][</span><span class="mh">23</span><span class="o">:</span><span class="mh">16</span><span class="p">],</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="n">led_index</span><span class="p">][</span><span class="mh">15</span><span class="o">:</span><span class="mh">8</span><span class="p">],</span><span class="w"> </span><span class="n">led_rgb</span><span class="p">[</span><span class="n">led_index</span><span class="p">][</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]};</span>
<span class="w">          </span><span class="n">bit_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">23</span><span class="p">;</span>

<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shift_reg</span><span class="p">[</span><span class="mh">23</span><span class="p">])</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">T1H</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">T0H</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>

<span class="w">          </span><span class="n">ws_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="n">state</span><span class="w">  </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_SEND_HIGH</span><span class="p">;</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">STATE_SEND_HIGH:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">bit_index</span><span class="p">]</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">T1L</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">T0L</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">ws_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_SEND_LOW</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">STATE_SEND_LOW:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bit_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">led_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">7</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">T_RESET</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_RESET</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">                </span><span class="n">led_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">led_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">                </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD_LED</span><span class="p">;</span>
<span class="w">              </span><span class="k">end</span>
<span class="w">            </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">              </span><span class="n">bit_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">bit_index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">bit_index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="p">(</span><span class="n">T1H</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="n">T0H</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">);</span>
<span class="w">              </span><span class="n">ws_out</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">              </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_SEND_HIGH</span><span class="p">;</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">          </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="nl">STATE_RESET:</span>
<span class="w">        </span><span class="k">begin</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">led_index</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD_LED</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">            </span><span class="n">timer</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">          </span><span class="k">end</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">STATE_LOAD_LED</span><span class="p">;</span>

<span class="w">      </span><span class="k">endcase</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/register_file.v</h2>
<h3 id="module-register_file">Modul: register_file</h3>
<p><strong>Kurzbeschreibung:</strong> Registerdatei für den CPU-Kern.</p>
<p>Diese Registerdatei umfasst entweder 32 Register (im RV32I-Mode) oder 16 Register (ansonsten) und unterstützt Lese- und Schreibzugriffe. Der Schreibzugriff erfolgt über ein Write-Enable-Signal, sowie Auswahl des Ziel- und Quellregisters. Bei RISC-V (RV32I) bleibt das Register x0 jederzeit auf 0.  @macro RV32I Falls definiert, werden 32 Register angelegt.</p>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>             Systemtakt.</li>
<li><code>rst_n</code>           Asynchroner, aktiver-LOW Reset.</li>
<li><code>we</code>              Write-Enable-Signal zum Beschreiben eines Registers.</li>
<li><code>[4:0]</code> rd        Zielregister, in das bei we=1 geschrieben werden soll.</li>
<li><code>[4:0]</code> rs1       Erstes Quellregister für eine Leseanfrage.</li>
<li><code>[4:0]</code> rs2       Zweites Quellregister für eine Leseanfrage.</li>
<li><code>[31:0]</code> rd_data  Daten, die in rd geschrieben werden (falls we=1).</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>[31:0]</code> rs1_data Daten aus dem Register rs1.</li>
<li><code>[31:0]</code> rs2_data Daten aus dem Register rs2.</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;./defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">register_file</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rd</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rd_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs1_data</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rs2_data</span>
<span class="p">);</span>

<span class="no">`ifdef</span><span class="w"> </span><span class="n">RV32I</span>
<span class="w">  </span><span class="c1">// Bei aktiviertem RV32I-Macro werden 32 Register definiert (1..31).</span>
<span class="w">  </span><span class="c1">// Register 0 bleibt immer 0.</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">registers</span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">1</span><span class="p">];</span>
<span class="no">`else</span>
<span class="w">  </span><span class="c1">// Sonst 16 Register (1..15).</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">registers</span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">1</span><span class="p">];</span>
<span class="no">`endif</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Lesezugriffe:</span>
<span class="w">  </span><span class="c1">// - Wenn rs1 != 0, wird das entsprechende Register ausgegeben,</span>
<span class="w">  </span><span class="c1">//   sonst 0.</span>
<span class="w">  </span><span class="c1">// - Wenn rs2 != 0, wird das entsprechende Register ausgegeben,</span>
<span class="w">  </span><span class="c1">//   sonst 0.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">RV32I</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rs1_data</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rs1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">registers</span><span class="p">[</span><span class="n">rs1</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rs2_data</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rs2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">registers</span><span class="p">[</span><span class="n">rs2</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="no">`else</span>
<span class="w">  </span><span class="c1">// Nur die unteren 16 Register sind gültig (rd[4] = 0).</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rs1_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rs1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">rs1</span><span class="p">[</span><span class="mh">4</span><span class="p">])</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">registers</span><span class="p">[</span><span class="n">rs1</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">rs2_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rs2</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">rs2</span><span class="p">[</span><span class="mh">4</span><span class="p">])</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">registers</span><span class="p">[</span><span class="n">rs2</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="no">`endif</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Schreibzugriffe:</span>
<span class="w">  </span><span class="c1">// - Bei RV32I wird registr[rd] nur beschrieben, wenn rd != 0.</span>
<span class="w">  </span><span class="c1">// - Ansonsten nur, wenn rd != 0 und rd[4] nicht gesetzt.</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">negedge</span><span class="w"> </span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">  </span><span class="k">begin</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">rst_n</span><span class="p">)</span>
<span class="w">    </span><span class="k">begin</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">2</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">4</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">6</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">8</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="w"> </span><span class="mh">9</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">10</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">11</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">12</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">13</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">14</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">15</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">RV32I</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">16</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">17</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">18</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">19</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">20</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">21</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">22</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">23</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">24</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">25</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">26</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">27</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">28</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">29</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">30</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="mh">31</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">else</span>
<span class="no">`ifdef</span><span class="w"> </span><span class="n">RV32I</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="p">))</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="n">rd</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rd_data</span><span class="p">;</span>
<span class="no">`else</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">we</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">rd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">5</span><span class="mi">&#39;d0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">~</span><span class="n">rd</span><span class="p">[</span><span class="mh">4</span><span class="p">])</span>
<span class="w">      </span><span class="n">registers</span><span class="p">[</span><span class="n">rd</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rd_data</span><span class="p">;</span>
<span class="no">`endif</span>
<span class="w">  </span><span class="k">end</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>

<h2>Datei: rtl/wgr_v_max.v</h2>
<h3 id="module-wgr_v_max">Modul: wgr_v_max</h3>
<p><strong>Kurzbeschreibung:</strong> Top-Level Modul („wgr_v_max“) eines minimalistischen SoC-Systems in HDL (mit CPU, Speicher und Peripherie).</p>
<p>Dieses Modul instanziiert die CPU (<code>cpu.v</code>) sowie den Hauptspeicher (<code>memory.v</code>). Es stellt außerdem einige grundlegende externe Signale bereit (UART, SPI, PWM, WS, GPIO) und kann somit als oberstes Top-Level Modul fungieren.  Zusätzlich enthält es hier exemplarisch einen einfachen LED-Lauflicht-Zähler, der in <code>gpio_shift</code> gespeicherte Bits nacheinander auf <code>gpio_out</code> legt.</p>
<p><strong>Eingänge:</strong></p>
<ul>
<li><code>clk</code>        Systemtakt</li>
<li><code>rst_n</code>      Asynchroner, aktiver-LOW Reset</li>
<li><code>uart_rx</code>    RX-Eingang der UART-Schnittstelle</li>
<li><code>spi_miso</code>   SPI-Eingang (Slave-&gt;Master)</li>
<li><code>[</code> 7:0]     gpio_in   GPIO-Eingänge</li>
</ul>
<p><strong>Ausgänge:</strong></p>
<ul>
<li><code>uart_tx</code>    TX-Ausgang der UART-Schnittstelle</li>
<li><code>[31:0]</code>     debug_out Debugging-Signal aus dem Debug-Modul</li>
<li><code>pwm_out</code>    PWM-Ausgang</li>
<li><code>ws_out</code>     Datenleitung für WS2812B-LEDs</li>
<li><code>spi_mosi</code>   SPI-Ausgang (Master-&gt;Slave)</li>
<li><code>spi_clk</code>    SPI-Takt</li>
<li><code>spi_cs</code>     SPI-Chipselect</li>
<li><code>[</code> 7:0]     gpio_out GPIO-Ausgänge</li>
<li><code>[</code> 7:0]     gpio_dir GPIO-Richtung (derzeit ungenutzt)</li>
</ul>
<details>
<summary>Source Code</summary>


<div class="codehilite"><pre><span></span><code><span class="no">`include</span><span class="w"> </span><span class="s">&quot;./defines.v&quot;</span>
<span class="no">`default_nettype</span><span class="w"> </span><span class="n">none</span>
<span class="no">`timescale</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mh">1</span><span class="n">ns</span>



<span class="k">module</span><span class="w"> </span><span class="n">wgr_v_max</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">rst_n</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_tx</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">uart_rx</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">debug_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">pwm_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">ws_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_mosi</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_miso</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_clk</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w">        </span><span class="n">spi_cs</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_out</span><span class="p">,</span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_dir</span><span class="p">,</span>
<span class="w">  </span><span class="k">input</span><span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">gpio_in</span>
<span class="p">);</span>


<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Interne Verbindungs-Signale zwischen CPU und Memory</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">address</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">write_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">read_data</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">mem_busy</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">we</span><span class="p">;</span>
<span class="w">  </span><span class="kt">wire</span><span class="w">        </span><span class="n">re</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Beispiel: Lauflicht-Steuerung für GPIO</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>

<span class="w">  </span><span class="c1">//assign gpio_out = gpio_shift;</span>

<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">  </span><span class="n">gpio_shift</span><span class="p">;</span>

<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">22</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">counter</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mh">23</span><span class="mi">&#39;d6000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">0</span><span class="p">;</span>
<span class="w">          </span><span class="n">gpio_shift</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8</span><span class="mb">&#39;b00000001</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<span class="w">          </span><span class="n">position</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">position</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">3</span><span class="mi">&#39;d7</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mh">0</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">          </span><span class="n">counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// CPU-Instanz: generiert Adresse, write_data, we, re und</span>
<span class="w">  </span><span class="c1">// empfängt read_data sowie mem_busy</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">cpu</span><span class="w"> </span><span class="n">cpu_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">address</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">read_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mem_busy</span><span class="w">   </span><span class="p">(</span><span class="n">mem_busy</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="c1">// Speicher-Modul (RAM/Peripherie), an das die CPU</span>
<span class="w">  </span><span class="c1">// ihre Zugriffe weiterleitet</span>
<span class="w">  </span><span class="c1">// ---------------------------------------------------------</span>
<span class="w">  </span><span class="n">memory</span><span class="w"> </span><span class="n">memory_inst</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">.</span><span class="n">clk</span><span class="w">        </span><span class="p">(</span><span class="n">clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">rst_n</span><span class="w">      </span><span class="p">(</span><span class="n">rst_n</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">address</span><span class="w">    </span><span class="p">(</span><span class="n">address</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">write_data</span><span class="w"> </span><span class="p">(</span><span class="n">write_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">read_data</span><span class="w">  </span><span class="p">(</span><span class="n">read_data</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">we</span><span class="w">         </span><span class="p">(</span><span class="n">we</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">re</span><span class="w">         </span><span class="p">(</span><span class="n">re</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">mem_busy</span><span class="w">   </span><span class="p">(</span><span class="n">mem_busy</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">uart_tx</span><span class="w">    </span><span class="p">(</span><span class="n">uart_tx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">uart_rx</span><span class="w">    </span><span class="p">(</span><span class="n">uart_rx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">debug_out</span><span class="w">  </span><span class="p">(</span><span class="n">debug_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">pwm_out</span><span class="w">    </span><span class="p">(</span><span class="n">pwm_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">ws_out</span><span class="w">     </span><span class="p">(</span><span class="n">ws_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_mosi</span><span class="w">   </span><span class="p">(</span><span class="n">spi_mosi</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_miso</span><span class="w">   </span><span class="p">(</span><span class="n">spi_miso</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_clk</span><span class="w">    </span><span class="p">(</span><span class="n">spi_clk</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">spi_cs</span><span class="w">     </span><span class="p">(</span><span class="n">spi_cs</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_out</span><span class="w">   </span><span class="p">(</span><span class="n">gpio_out</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_dir</span><span class="w">   </span><span class="p">(</span><span class="n">gpio_dir</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">gpio_in</span><span class="w">    </span><span class="p">(</span><span class="n">gpio_in</span><span class="p">)</span>
<span class="w">  </span><span class="p">);</span>

<span class="k">endmodule</span>
</code></pre></div>


</details>
</div>

    <script>
    function toggleSidebar() {
        var sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }
    document.addEventListener("DOMContentLoaded", function () {
        var links = document.querySelectorAll(".sidebar a");
        links.forEach(function (link) {
            link.addEventListener("click", function () {
                var sidebar = document.getElementById('sidebar');
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                }
            });
        });
    });
    </script>
    
</body>
</html>
